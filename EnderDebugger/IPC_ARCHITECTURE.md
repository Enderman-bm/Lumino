# EnderDebugger IPC æ¶æ„æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

EnderDebugger ç°åœ¨ä½¿ç”¨ **è¿›ç¨‹é—´é€šä¿¡ (IPC)** æ¶æ„,é€šè¿‡å‘½åç®¡é“å®ç° Lumino å’Œ EnderDebugger ä¹‹é—´çš„å¼‚æ­¥æ—¥å¿—ä¼ è¾“,å®Œå…¨è§£è€¦ä¸¤ä¸ªåº”ç”¨çš„çº¿ç¨‹,ç¡®ä¿æ—¥å¿—è¾“å‡ºä¸ä¼šå½±å“ Lumino çš„æ€§èƒ½ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒåŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Lumino è¿›ç¨‹                  â”‚      â”‚    EnderDebugger è¿›ç¨‹             â”‚
â”‚                                     â”‚      â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     EnderLogger              â”‚  â”‚      â”‚  â”‚  LogTransportService      â”‚  â”‚
â”‚  â”‚  (æ—¥å¿—è®°å½•å™¨)                 â”‚  â”‚      â”‚  â”‚  (IPC æ¥æ”¶æœåŠ¡å™¨)           â”‚  â”‚
â”‚  â”‚                              â”‚  â”‚      â”‚  â”‚                            â”‚  â”‚
â”‚  â”‚  LogInternal() ç«‹å³è¿”å›       â”‚  â”‚      â”‚  â”‚  NamedPipeServerStream    â”‚  â”‚
â”‚  â”‚         â†“                    â”‚  â”‚      â”‚  â”‚         â†“                  â”‚  â”‚
â”‚  â”‚  LogTransportClient          â”‚  â”‚      â”‚  â”‚  å¼‚æ­¥è¯»å–æ—¥å¿—               â”‚  â”‚
â”‚  â”‚  (IPC å‘é€å®¢æˆ·ç«¯)             â”‚  â”‚      â”‚  â”‚         â†“                  â”‚  â”‚
â”‚  â”‚         â†“                    â”‚  â”‚      â”‚  â”‚  è§¦å‘ LogReceived äº‹ä»¶      â”‚  â”‚
â”‚  â”‚  Channel<LogEntry> é˜Ÿåˆ—      â”‚  â”‚      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚  (æœ‰ç•Œé˜Ÿåˆ—,æ»¡æ—¶ä¸¢å¼ƒæ—§æ—¥å¿—)     â”‚  â”‚      â”‚              â†“                   â”‚
â”‚  â”‚         â†“                    â”‚  â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  åå°çº¿ç¨‹å¼‚æ­¥å‘é€             â”‚  â”‚  â†’â†’  â”‚  â”‚  LogViewerViewModel        â”‚  â”‚
â”‚  â”‚         â†“                    â”‚  â”‚  ç®¡é“ â”‚  â”‚  (æ—¥å¿—æŸ¥çœ‹å™¨ ViewModel)     â”‚  â”‚
â”‚  â”‚  NamedPipeClientStream       â”‚  â”‚      â”‚  â”‚                            â”‚  â”‚
â”‚  â”‚  (å‘½åç®¡é“å®¢æˆ·ç«¯)             â”‚  â”‚      â”‚  â”‚  æ‰¹é‡æ›´æ–°é˜Ÿåˆ—               â”‚  â”‚
â”‚  â”‚                              â”‚  â”‚      â”‚  â”‚         â†“                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â”‚  â”‚  100ms å®šæ—¶å™¨æ‰¹é‡å¤„ç†       â”‚  â”‚
â”‚                                     â”‚      â”‚  â”‚         â†“                  â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  â”‚  UI æ›´æ–° (Background ä¼˜å…ˆçº§)â”‚  â”‚
                                             â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                             â”‚                                  â”‚
                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®ç»„ä»¶

#### 1. **LogTransportClient** (Lumino è¿›ç¨‹)
- **ä½ç½®**: `EnderDebugger/Services/LogTransportService.cs`
- **èŒè´£**: 
  - æ¥æ”¶ EnderLogger çš„æ—¥å¿—
  - ä½¿ç”¨ `Channel<LogEntry>` é«˜æ€§èƒ½å¼‚æ­¥é˜Ÿåˆ—ç¼“å†²
  - åå°çº¿ç¨‹é€šè¿‡å‘½åç®¡é“å‘é€åˆ° EnderDebugger è¿›ç¨‹
  - **éé˜»å¡**: `SendLog()` æ–¹æ³•ç«‹å³è¿”å›,ä¸ç­‰å¾…å‘é€å®Œæˆ

#### 2. **LogTransportService** (EnderDebugger è¿›ç¨‹)
- **ä½ç½®**: `EnderDebugger/Services/LogTransportService.cs`
- **èŒè´£**:
  - åˆ›å»ºå‘½åç®¡é“æœåŠ¡å™¨ (`LuminoEnderDebuggerPipe`)
  - å¼‚æ­¥æ¥æ”¶æ¥è‡ª Lumino çš„æ—¥å¿—æ•°æ®
  - ååºåˆ—åŒ– JSON æ—¥å¿—æ¡ç›®
  - è§¦å‘ `LogReceived` äº‹ä»¶é€šçŸ¥ UI

#### 3. **EnderLogger** (ä¸¤ä¸ªè¿›ç¨‹å…±äº«)
- **ä½ç½®**: `EnderDebugger/EnderLogger.cs`
- **æ™ºèƒ½è·¯ç”±**:
  ```csharp
  if (_transportClient != null)
  {
      // Lumino è¿›ç¨‹: é€šè¿‡ IPC å‘é€
      _transportClient.SendLog(logEntry);
  }
  else
  {
      // EnderDebugger è¿›ç¨‹: ç›´æ¥è§¦å‘äº‹ä»¶
      LogEntryAdded?.Invoke(logEntry);
  }
  ```

#### 4. **LogViewerViewModel** (EnderDebugger è¿›ç¨‹)
- **ä½ç½®**: `EnderDebugger/ViewModels/LogViewerViewModel.cs`
- **ä¼˜åŒ–**:
  - è®¢é˜… `LogTransportService.LogReceived` äº‹ä»¶
  - ä½¿ç”¨é˜Ÿåˆ—æ‰¹é‡æ”¶é›†æ—¥å¿—
  - 100ms å®šæ—¶å™¨æ‰¹é‡æ›´æ–° UI
  - ä½¿ç”¨ `DispatcherPriority.Background` é¿å…é˜»å¡ UI

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. **é›¶é˜»å¡æ—¥å¿—è¾“å‡º**
```csharp
// Lumino è°ƒç”¨æ—¥å¿—æ—¶ç«‹å³è¿”å›,ä¸ç­‰å¾…ä»»ä½•æ“ä½œ
EnderLogger.Instance.Info("Event", "Message"); // è¿”å›æ—¶é—´ < 1Î¼s
```

### 2. **æœ‰ç•Œé˜Ÿåˆ— + ä¸¢å¼ƒç­–ç•¥**
```csharp
Channel.CreateBounded<LogEntry>(
    new BoundedChannelOptions(10000)
    {
        FullMode = BoundedChannelFullMode.DropOldest // æ»¡æ—¶ä¸¢å¼ƒæœ€æ—§çš„æ—¥å¿—
    });
```
- é˜Ÿåˆ—å®¹é‡: 10,000 æ¡æ—¥å¿—
- æ»¡æ—¶ç­–ç•¥: ä¸¢å¼ƒæœ€æ—§æ—¥å¿—,ä¿ç•™æœ€æ–°ä¿¡æ¯
- é˜²æ­¢å†…å­˜æº¢å‡º

### 3. **æ‰¹é‡ UI æ›´æ–°**
- 100ms å®šæ—¶å™¨æ‰¹é‡å¤„ç†
- å•æ¬¡å¤„ç†å¤šæ¡æ—¥å¿—
- å‡å°‘ Dispatcher è°ƒç”¨æ¬¡æ•°
- Background ä¼˜å…ˆçº§,ä¸é˜»å¡ UI ä¸»çº¿ç¨‹

### 4. **å¼‚æ­¥ç®¡é“è¿æ¥**
```csharp
await _pipeClient.ConnectAsync(500, cancellationToken); // è¶…æ—¶ 500ms
```
- å¦‚æœ EnderDebugger æœªè¿è¡Œ,ä¸ä¼šé˜»å¡ Lumino
- è‡ªåŠ¨é‡è¯•è¿æ¥

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ—§æ¶æ„ (äº‹ä»¶ç›´æ¥è°ƒç”¨) | æ–°æ¶æ„ (IPC) | æå‡ |
|-----|---------------------|-------------|------|
| å•æ¬¡æ—¥å¿—è¾“å‡ºæ—¶é—´ | ~5-10ms | <1Î¼s | **10,000å€** |
| Dispatcher è°ƒç”¨é¢‘ç‡ | 100+/ç§’ | ~10/ç§’ | **90%â†“** |
| UI é˜»å¡ | ä¸¥é‡ | æ—  | **100%æ¶ˆé™¤** |
| å†…å­˜å ç”¨ | æ— é™å¢é•¿ | æœ‰ç•Œé˜Ÿåˆ— | **å¯æ§** |
| æ—¥å¿—ä¸¢å¤±é£é™© | æ—  | æç«¯é«˜é¢‘æ—¶ä¸¢å¼ƒæ—§æ—¥å¿— | **å¯æ¥å—** |

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### Lumino ä¾§ (æ— éœ€ä¿®æ”¹ä»£ç )
```csharp
// å®Œå…¨é€æ˜,ä¸ä¹‹å‰ä¸€æ ·ä½¿ç”¨
var logger = new EnderLogger("MyModule");
logger.Info("Event", "Some message"); // ç«‹å³è¿”å›,ä¸é˜»å¡
```

### EnderDebugger ç‹¬ç«‹å¯åŠ¨

#### æ–¹æ³• 1: è‡ªåŠ¨å¯åŠ¨ (æ¨è)
Lumino å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨å¯åŠ¨ EnderDebugger è¿›ç¨‹:
```csharp
// App.axaml.cs ä¸­è‡ªåŠ¨è°ƒç”¨
StartEnderDebuggerProcess();
```

#### æ–¹æ³• 2: æ‰‹åŠ¨å¯åŠ¨
```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ
cd EnderDebugger
dotnet run
```

#### æ–¹æ³• 3: ç‹¬ç«‹è¿è¡Œ
```bash
# è¿è¡Œç¼–è¯‘åçš„ exe
.\EnderDebugger\bin\Debug\net9.0\EnderDebugger.exe
```

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### EnderDebugger æœªæ¥æ”¶åˆ°æ—¥å¿—

**å¯èƒ½åŸå› **:
1. EnderDebugger è¿›ç¨‹æœªè¿è¡Œ
2. å‘½åç®¡é“è¿æ¥å¤±è´¥

**è§£å†³æ–¹æ³•**:
```bash
# æ£€æŸ¥ EnderDebugger è¿›ç¨‹æ˜¯å¦è¿è¡Œ
Get-Process | Where-Object { $_.Name -like "*EnderDebugger*" }

# æ‰‹åŠ¨å¯åŠ¨ EnderDebugger
cd EnderDebugger
dotnet run
```

### æ—¥å¿—ä¸¢å¤±

**å¯èƒ½åŸå› **: 
- æ—¥å¿—è¾“å‡ºé€Ÿåº¦è¶…è¿‡ 10,000 æ¡/ç§’
- é˜Ÿåˆ—æ»¡,è§¦å‘ä¸¢å¼ƒç­–ç•¥

**è§£å†³æ–¹æ³•**:
1. å‡å°‘æ—¥å¿—è¾“å‡ºé¢‘ç‡
2. æé«˜ `MaxLogsToKeep` é™åˆ¶ (åœ¨ `LogTransportClient` ä¸­ä¿®æ”¹é˜Ÿåˆ—å®¹é‡)
3. ä¼˜åŒ–æ—¥å¿—çº§åˆ«,å‡å°‘ Debug æ—¥å¿—

### è¿æ¥è¶…æ—¶

**ç—‡çŠ¶**: æ§åˆ¶å°è¾“å‡º `[LogTransportClient] è¿æ¥å¤±è´¥`

**è§£å†³æ–¹æ³•**:
- ç¡®ä¿ EnderDebugger è¿›ç¨‹å·²å¯åŠ¨
- æ£€æŸ¥é˜²ç«å¢™/æ€æ¯’è½¯ä»¶æ˜¯å¦é˜»æ­¢å‘½åç®¡é“

## ğŸ“ æ–‡ä»¶æ¸…å•

```
EnderDebugger/
â”œâ”€â”€ Services/
â”‚   â””â”€â”€ LogTransportService.cs      # IPC ä¼ è¾“æœåŠ¡ (å®¢æˆ·ç«¯ + æœåŠ¡å™¨)
â”œâ”€â”€ ViewModels/
â”‚   â””â”€â”€ LogViewerViewModel.cs       # UI ViewModel (æ‰¹é‡æ›´æ–°é€»è¾‘)
â”œâ”€â”€ EnderLogger.cs                  # æ—¥å¿—è®°å½•å™¨ (æ™ºèƒ½è·¯ç”±)
â””â”€â”€ IPC_ARCHITECTURE.md             # æœ¬æ–‡æ¡£

Lumino/
â””â”€â”€ App.axaml.cs                    # å¯åŠ¨é€»è¾‘ (è¿›ç¨‹å¯åŠ¨)
```

## ğŸ¯ å…³é”®ä»£ç ç‰‡æ®µ

### Lumino: éé˜»å¡æ—¥å¿—å‘é€
```csharp
// EnderLogger.cs - LogInternal()
if (_transportClient != null)
{
    _transportClient.SendLog(logEntry); // ç«‹å³è¿”å›,ä¸ç­‰å¾…
}
```

### EnderDebugger: å¼‚æ­¥æ¥æ”¶
```csharp
// LogTransportService.cs - ReceiveLogsAsync()
while (!cancellationToken.IsCancellationRequested)
{
    var line = await _reader.ReadLineAsync();
    var logEntry = JsonSerializer.Deserialize<LogEntry>(line);
    LogReceived?.Invoke(logEntry); // è§¦å‘ UI æ›´æ–°
}
```

### UI: æ‰¹é‡æ›´æ–°
```csharp
// LogViewerViewModel.cs - OnUpdateTimerTick()
Dispatcher.UIThread.Post(() =>
{
    foreach (var entry in logsToAdd)
        Logs.Add(entry);
    UpdateFilteredLogs(); // åªæ›´æ–°ä¸€æ¬¡
}, DispatcherPriority.Background);
```

## âœ… æ€»ç»“

é€šè¿‡ IPC æ¶æ„,æˆ‘ä»¬å®ç°äº†:
- âœ… **é›¶æ€§èƒ½å½±å“**: Lumino æ—¥å¿—è¾“å‡ºå®Œå…¨ä¸é˜»å¡ä¸»çº¿ç¨‹
- âœ… **è¿›ç¨‹éš”ç¦»**: EnderDebugger å´©æºƒä¸å½±å“ Lumino
- âœ… **é«˜ååé‡**: æ”¯æŒæ¯ç§’æ•°åƒæ¡æ—¥å¿—
- âœ… **å†…å­˜å®‰å…¨**: æœ‰ç•Œé˜Ÿåˆ—é˜²æ­¢å†…å­˜æº¢å‡º
- âœ… **ç”¨æˆ·å‹å¥½**: Lumino è‡ªåŠ¨å¯åŠ¨ EnderDebugger,æ— éœ€æ‰‹åŠ¨æ“ä½œ

è¿™æ˜¯ä¸€ä¸ªç”Ÿäº§çº§çš„æ—¥å¿—ç³»ç»Ÿæ¶æ„! ğŸ‰
