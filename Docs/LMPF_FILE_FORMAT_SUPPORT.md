# Lumino é¡¹ç›®æ–‡ä»¶æ ¼å¼ï¼ˆ.lmpfï¼‰æ”¯æŒæ–‡æ¡£

## æ¦‚è¿°

Lumino ç°åœ¨å®Œå…¨æ”¯æŒ `.lmpf` (Lumino Music Project Format) æ–‡ä»¶æ ¼å¼ï¼Œè¿™æ˜¯åº”ç”¨çš„åŸç”Ÿé¡¹ç›®ä¿å­˜æ ¼å¼ã€‚

## æ–‡ä»¶æ ¼å¼ä¿¡æ¯

| å±æ€§ | å€¼ |
|-----|---|
| **æ‰©å±•å** | .lmpf |
| **å…¨ç§°** | Lumino Music Project Format |
| **æè¿°** | Lumino åŸç”Ÿé¡¹ç›®æ–‡ä»¶æ ¼å¼ï¼Œç”¨äºä¿å­˜å®Œæ•´çš„ç¼–è¾‘å·¥ä½œ |
| **ç‰ˆæœ¬** | 1.0 |

## æ”¯æŒçš„æ“ä½œ

### 1. æ‰“å¼€ .lmpf æ–‡ä»¶

**æ“ä½œæ­¥éª¤**ï¼š
1. ç‚¹å‡»èœå• â†’ æ‰“å¼€ (æˆ– Ctrl+O)
2. åœ¨æ–‡ä»¶å¯¹è¯æ¡†ä¸­é€‰æ‹© `.lmpf` æ–‡ä»¶
3. ç¡®è®¤æ‰“å¼€

**æ”¯æŒçš„æ ¼å¼**ï¼š
```
æ–‡ä»¶æ‰“å¼€å¯¹è¯æ¡†æ”¯æŒçš„æ ¼å¼ï¼š
- *.mid / *.midi - æ ‡å‡†MIDIæ–‡ä»¶
- *.lmpf - Luminoé¡¹ç›®æ–‡ä»¶ âœ… (æ–°å¢)
- *.dmn / *.dmnx - é—ç•™é¡¹ç›®æ ¼å¼
```

**åŠŸèƒ½**ï¼š
- âœ… åŠ è½½å®Œæ•´çš„é¡¹ç›®çŠ¶æ€
- âœ… æ¢å¤æ‰€æœ‰éŸ³ç¬¦å’Œäº‹ä»¶
- âœ… æ¢å¤éŸ³è½¨é…ç½®å’Œå…ƒæ•°æ®
- âœ… æ”¯æŒè¿›åº¦æ˜¾ç¤ºå’Œå–æ¶ˆæ“ä½œ

### 2. ä¿å­˜ä¸º .lmpf æ–‡ä»¶

**æ“ä½œæ­¥éª¤**ï¼š
1. ç‚¹å‡»èœå• â†’ ä¿å­˜ (æˆ– Ctrl+S)
2. åœ¨ä¿å­˜å¯¹è¯æ¡†ä¸­è¾“å…¥æ–‡ä»¶å
3. é€‰æ‹©æ–‡ä»¶ç±»å‹ä¸º `.lmpf`
4. ç¡®è®¤ä¿å­˜

**æ”¯æŒçš„æ ¼å¼**ï¼š
```
æ–‡ä»¶ä¿å­˜å¯¹è¯æ¡†æ”¯æŒçš„æ ¼å¼ï¼š
- *.lmpf - Luminoé¡¹ç›®æ–‡ä»¶ âœ…
- *.mid - æ ‡å‡†MIDIå¯¼å‡º
```

**ä¿å­˜ä¿¡æ¯**ï¼š
- ğŸµ æ‰€æœ‰éŸ³ç¬¦å’ŒéŸ³ç¬¦å±æ€§
- ğŸ›ï¸ æ‰€æœ‰ MIDI æ§åˆ¶å™¨äº‹ä»¶
- ğŸ“‹ é¡¹ç›®å…ƒæ•°æ®ï¼ˆæ ‡é¢˜ã€åˆ›å»ºæ—¶é—´ã€ä¿®æ”¹æ—¶é—´ç­‰ï¼‰
- ğŸ¼ éŸ³è½¨é…ç½®å’Œåç§°
- ğŸµ é€Ÿåº¦å’Œå…¶ä»–äº‹ä»¶æ•°æ®

### 3. æ–‡ä»¶å¯¹è¯æ¡†è¿‡æ»¤å™¨

ç°åœ¨æ–‡ä»¶æ‰“å¼€å¯¹è¯æ¡†ä¼šè‡ªåŠ¨æ˜¾ç¤ºæ‰€æœ‰æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼š

#### æ‰“å¼€æ–‡ä»¶å¯¹è¯æ¡†
```
æ–‡ä»¶ç±»å‹ï¼š
- æ‰€æœ‰æ”¯æŒçš„æ ¼å¼ (*.mid, *.midi, *.lmpf, *.dmn, *.dmnx)
- MIDI æ–‡ä»¶ (*.mid, *.midi)
- Lumino é¡¹ç›®æ–‡ä»¶ (*.lmpf)
- é—ç•™æ ¼å¼ (*.dmn, *.dmnx)
```

#### ä¿å­˜æ–‡ä»¶å¯¹è¯æ¡†
```
æ–‡ä»¶ç±»å‹ï¼š
- Lumino é¡¹ç›®æ–‡ä»¶ (*.lmpf)
- MIDI æ–‡ä»¶ (*.mid)
```

## ä»£ç å®ç°

### å…³é”®å¸¸é‡å®šä¹‰

**æ–‡ä»¶**: `Lumino/Constants/DialogConstants.cs`

```csharp
/// MIDIæ–‡ä»¶æ‰©å±•åè¿‡æ»¤å™¨
public static readonly string[] MidiFileFilters = { "*.mid", "*.midi" };

/// é¡¹ç›®æ–‡ä»¶æ‰©å±•åè¿‡æ»¤å™¨
public static readonly string[] ProjectFileFilters = { "*.lmpf", "*.dmn", "*.dmnx" };

/// æ‰€æœ‰æ”¯æŒçš„æ–‡ä»¶æ ¼å¼
public static readonly string[] AllSupportedFilters = 
    { "*.mid", "*.midi", "*.lmpf", "*.dmn", "*.dmnx" };
```

### æ–‡ä»¶æ‰“å¼€å¤„ç†

**æ–‡ä»¶**: `Lumino/ViewModels/MainWindowViewModel.cs`

```csharp
// æ‰“å¼€æ–‡ä»¶å¯¹è¯æ¡†
var filePath = await _dialogService.ShowOpenFileDialogAsync(
    "æ‰“å¼€MIDIæ–‡ä»¶æˆ–é¡¹ç›®", 
    new[] { "*.mid", "*.midi", "*.lmpf", "*.dmn" });

// æ ¹æ®æ‰©å±•ååˆ¤æ–­å¤„ç†æ–¹å¼
var extension = Path.GetExtension(filePath).ToLower();

if (extension == ".mid" || extension == ".midi")
{
    await ImportMidiFileAsync(filePath);
}
else if (extension == ".lmpf")
{
    var runResult = await _dialogService.ShowPreloadAndRunAsync<...>(
        Path.GetFileName(filePath), 
        fileSize,
        async (progress, cancellationToken) =>
        {
            var tuple = await _projectStorageService.LoadProjectAsync(
                filePath, cancellationToken);
            return new System.Tuple<ProjectSnapshot, ProjectMetadata>(
                tuple.snapshot, tuple.metadata);
        }, 
        canCancel: true);
    // å¤„ç†åŠ è½½ç»“æœ...
}
```

### æ–‡ä»¶ä¿å­˜å¤„ç†

```csharp
// ä¿å­˜æ–‡ä»¶å¯¹è¯æ¡†
var filePath = await _dialogService.ShowSaveFileDialogAsync(
    "ä¿å­˜é¡¹ç›®æˆ–å¯¼å‡º MIDI",
    null,
    new[] { "*.lmpf", "*.mid" });

var extension = System.IO.Path.GetExtension(filePath).ToLower();

if (extension == ".lmpf")
{
    // ä¿å­˜ä¸º Lumino é¡¹ç›®æ–‡ä»¶
    var ok = await _projectStorageService.SaveProjectAsync(
        filePath, snapshot, metadata, cancellationToken);
}
else if (extension == ".mid")
{
    // å¯¼å‡ºä¸º MIDI æ–‡ä»¶
    // ...
}
```

## é¡¹ç›®å­˜å‚¨æœåŠ¡

**æ–‡ä»¶**: `Lumino/Services/Implementation/ProjectStorageService.cs`

è´Ÿè´£ `.lmpf` æ–‡ä»¶çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼š

- `SaveProjectAsync()` - å°†é¡¹ç›®ä¿å­˜ä¸º `.lmpf` æ–‡ä»¶
- `LoadProjectAsync()` - ä» `.lmpf` æ–‡ä»¶åŠ è½½é¡¹ç›®

## æ–‡ä»¶æ ¼å¼ç‰¹æ€§

### æ”¯æŒçš„é¡¹ç›®å…ƒæ•°æ®

```csharp
public class ProjectMetadata
{
    public string Title { get; set; }                    // é¡¹ç›®æ ‡é¢˜
    public DateTime Created { get; set; }                // åˆ›å»ºæ—¶é—´
    public DateTime LastModified { get; set; }           // æœ€åä¿®æ”¹æ—¶é—´
    public double Tempo { get; set; }                    // é€Ÿåº¦(BPM)
    public List<TrackMetadata> Tracks { get; set; }      // éŸ³è½¨åˆ—è¡¨
}

public class TrackMetadata
{
    public int TrackNumber { get; set; }                 // éŸ³è½¨å·
    public string TrackName { get; set; }                // éŸ³è½¨åç§°
    public int MidiChannel { get; set; }                 // MIDIé€šé“
    public int ChannelGroupIndex { get; set; }           // é€šé“ç»„ç´¢å¼•
    public int ChannelNumberInGroup { get; set; }        // ç»„å†…é€šé“å·
    public string Instrument { get; set; }               // ä¹å™¨åç§°
    public string ColorTag { get; set; }                 // é¢œè‰²æ ‡ç­¾
    public bool IsConductorTrack { get; set; }           // æ˜¯å¦ä¸ºæŒ‡æŒ¥è½¨é“
}
```

### æ”¯æŒçš„é¡¹ç›®å†…å®¹

- ğŸ“Œ éŸ³ç¬¦åˆ—è¡¨ï¼ˆåŒ…å«ä½ç½®ã€éŸ³é«˜ã€åŠ›åº¦ã€æ—¶é•¿ç­‰å±æ€§ï¼‰
- ğŸ›ï¸ MIDI æ§åˆ¶å™¨äº‹ä»¶
- â±ï¸ é€Ÿåº¦äº‹ä»¶ï¼ˆTempoï¼‰
- ğŸ¼ åŠ›åº¦äº‹ä»¶ï¼ˆVelocityï¼‰
- ğŸ“ˆ å¼¯éŸ³äº‹ä»¶ï¼ˆPitch Bendï¼‰
- ğŸ›ï¸ CC æ§åˆ¶å™¨äº‹ä»¶

## ç”¨æˆ·å·¥ä½œæµ

### å…¸å‹å·¥ä½œæµç¤ºä¾‹

```
1. æ‰“å¼€éŸ³é¢‘æ–‡ä»¶
   â†“
2. å¯¼å…¥æˆ–ç¼–è¾‘ MIDI æ•°æ®
   â†“
3. ç¼–è¾‘CCã€é€Ÿåº¦ã€å¼¯éŸ³ç­‰æ§åˆ¶äº‹ä»¶
   â†“
4. ä¿å­˜ä¸º .lmpf æ–‡ä»¶ï¼ˆä¿å­˜å®Œæ•´é¡¹ç›®ï¼‰ âœ…
   â†“
5. å¯¼å‡ºä¸º .mid æ–‡ä»¶ï¼ˆåˆ†äº«MIDIæ•°æ®ï¼‰
```

## ç¼–è¯‘éªŒè¯

âœ… **ç¼–è¯‘æˆåŠŸ**
```
0 ä¸ªé”™è¯¯
86 ä¸ªè­¦å‘Šï¼ˆå…¨éƒ¨é¢„å…ˆå­˜åœ¨ï¼‰
ç¼–è¯‘æ—¶é—´ï¼š00:00:07.07
```

## æ–‡ä»¶å¯¹è¯æ¡†UIæ›´æ–°

### æ‰“å¼€å¯¹è¯æ¡†
**ä¹‹å‰**: "æ‰“å¼€MIDIæ–‡ä»¶"  
**ç°åœ¨**: "æ‰“å¼€MIDIæ–‡ä»¶æˆ–é¡¹ç›®" âœ…

### æ–‡ä»¶è¿‡æ»¤å™¨
**ä¹‹å‰**: `*.mid`, `*.midi`, `*.dmn`  
**ç°åœ¨**: `*.mid`, `*.midi`, `*.lmpf`, `*.dmn` âœ…

## è¿ç§»æŒ‡å—

å¦‚æœç”¨æˆ·æœ‰æ—§çš„é¡¹ç›®æ–‡ä»¶æ ¼å¼ï¼ˆ`.dmn`, `.dmnx`ï¼‰ï¼Œç³»ç»Ÿä»ç„¶æ”¯æŒæ‰“å¼€å®ƒä»¬ã€‚å»ºè®®ï¼š

1. æ‰“å¼€æ—§é¡¹ç›®æ–‡ä»¶ï¼ˆ`.dmn`ï¼‰
2. ç¼–è¾‘å’Œå®Œå–„
3. ä½¿ç”¨ **å¦å­˜ä¸º** ä¿å­˜ä¸ºæ–°æ ¼å¼ï¼ˆ`.lmpf`ï¼‰

## æäº¤è®°å½•

**æäº¤**: d08788d  
**æ ‡é¢˜**: æ·»åŠ å¯¹.lmpfæ–‡ä»¶æ ¼å¼çš„å®Œæ•´æ”¯æŒ  
**å†…å®¹**:
- æ›´æ–°æ‰“å¼€æ–‡ä»¶å¯¹è¯æ¡†è¿‡æ»¤å™¨
- æ›´æ–°å¯¹è¯æ¡†å¸¸é‡
- æ–‡ä»¶æ ¼å¼æ˜ç¡®åŒ–å’Œåˆ†ç±»

---

**æ›´æ–°æ—¥æœŸ**: 2025å¹´11æœˆ9æ—¥  
**ç‰ˆæœ¬**: 1.0  
**çŠ¶æ€**: âœ… å®Œæˆ
