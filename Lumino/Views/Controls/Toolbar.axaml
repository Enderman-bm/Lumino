<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:Lumino.ViewModels.Editor.Components"
             xmlns:editor="using:Lumino.ViewModels.Editor"
             xmlns:enums="using:Lumino.ViewModels.Editor.Enums"
             xmlns:models="using:Lumino.Models.Music"
             xmlns:converters="using:Lumino.Views.Converters"
             xmlns:controls="using:Lumino.Views.Controls"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="44"
             x:Class="Lumino.Views.Controls.Toolbar"
             x:DataType="vm:ToolbarViewModel">

	<Design.DataContext>
		<vm:ToolbarViewModel/>
	</Design.DataContext>

	<UserControl.Styles>
		<!-- ä¸‹æ‹‰èœå•å¹³æ»‘ä¸‹æ»‘åŠ¨ç”» -->
		<Style Selector="Popup Border">
			<Setter Property="Transitions">
				<Transitions>
					<DoubleTransition Property="Opacity" Duration="0:0:0.2" Easing="CubicEaseOut"/>
					<CornerRadiusTransition Property="CornerRadius" Duration="0:0:0.15"/>
				</Transitions>
			</Setter>
			<Setter Property="Opacity" Value="0"/>
		</Style>

		<Style Selector="Popup:open Border">
			<Setter Property="Opacity" Value="1"/>
		</Style>

		<!-- å®šä¹‰é€šç”¨æŒ‰é’®æ ·å¼ - åº”ç”¨åˆ°æ‰€æœ‰æŒ‰é’® -->
		<Style Selector="Button">
			<Setter Property="Transitions">
				<Transitions>
					<BrushTransition Property="Background" Duration="0:0:0.15"/>
					<ThicknessTransition Property="BorderThickness" Duration="0:0:0.15"/>
				</Transitions>
			</Setter>
		</Style>

		<!-- å·¥å…·æ æŒ‰é’®åŸºç¡€æ ·å¼ -->
		<Style Selector="Button.ToolButton">
			<Setter Property="Width" Value="32"/>
			<Setter Property="Height" Value="32"/>
			<Setter Property="Margin" Value="2"/>
			<Setter Property="Padding" Value="6"/>
			<Setter Property="Background" Value="Transparent"/>
			<Setter Property="BorderThickness" Value="0"/>
			<Setter Property="CornerRadius" Value="16"/>
		</Style>

		<!-- æ¿€æ´»çŠ¶æ€ï¼ˆé€‰ä¸­çš„å·¥å…·ï¼‰ - ä½¿ç”¨æµ…è‰²èƒŒæ™¯ï¼Œä¸æ”¹å˜å°ºå¯¸ -->
		<Style Selector="Button.ToolButton.active">
			<Setter Property="Background" Value="#15673AB7"/>
		</Style>

		<!-- æŒ‰é’®æ‚¬åœæ—¶ - æ˜¾ç¤ºé«˜äº®æ¶Ÿæ¼ª -->
		<Style Selector="Button.ToolButton:pointerover">
			<Setter Property="Background" Value="#1A673AB7"/>
		</Style>

		<!-- æŒ‰é’®æŒ‰ä¸‹æ—¶ - å¢žå¼ºæ¶Ÿæ¼ª + ç¼©æ”¾ -->
		<Style Selector="Button.ToolButton:pressed">
			<Setter Property="Background" Value="#30673AB7"/>
			<Setter Property="RenderTransform" Value="scale(0.94)"/>
		</Style>

		<!-- éŸ³ç¬¦æ—¶å€¼æŒ‰é’®åŸºç¡€æ ·å¼ -->
		<Style Selector="Button.NoteDurationButton">
			<Setter Property="MinWidth" Value="50"/>
			<Setter Property="Height" Value="32"/>
			<Setter Property="Margin" Value="2"/>
			<Setter Property="Padding" Value="12,6"/>
			<Setter Property="Background" Value="Transparent"/>
			<Setter Property="BorderThickness" Value="0"/>
			<Setter Property="CornerRadius" Value="16"/>
			<Setter Property="HorizontalContentAlignment" Value="Center"/>
			<Setter Property="VerticalContentAlignment" Value="Center"/>
		</Style>

		<!-- éŸ³ç¬¦æ—¶å€¼æŒ‰é’®æ‚¬åœæ—¶ - æ˜¾ç¤ºé«˜äº®æ¶Ÿæ¼ª -->
		<Style Selector="Button.NoteDurationButton:pointerover">
			<Setter Property="Background" Value="#1A673AB7"/>
		</Style>

		<!-- éŸ³ç¬¦æ—¶å€¼æŒ‰é’®æŒ‰ä¸‹æ—¶ - å¢žå¼ºæ¶Ÿæ¼ª + ç¼©æ”¾ -->
		<Style Selector="Button.NoteDurationButton:pressed">
			<Setter Property="Background" Value="#30673AB7"/>
			<Setter Property="RenderTransform" Value="scale(0.94)"/>
		</Style>

		<!-- ç¡®ä¿ TextBlock åœ¨æŒ‰é’®ä¸­å±…ä¸­ -->
		<Style Selector="Button TextBlock">
			<Setter Property="HorizontalAlignment" Value="Center"/>
			<Setter Property="VerticalAlignment" Value="Center"/>
			<Setter Property="TextAlignment" Value="Center"/>
		</Style>
	</UserControl.Styles>

	<!-- å·¥å…·æ å†…å®¹ -->
	<Border Background="{DynamicResource ToolbarBackgroundBrush}" 
	        Height="44" 
	        BorderBrush="{DynamicResource ToolbarBorderBrush}" 
	        BorderThickness="0,0,0,1">
		<Grid>
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="Auto"/>
				<ColumnDefinition Width="*"/>
				<ColumnDefinition Width="Auto"/>
			</Grid.ColumnDefinitions>

			<!-- å·¥å…·æŒ‰é’®ç»„ -->
			<StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center" Margin="8,0">
				<!-- é“…ç¬”å·¥å…· -->
				<Button Classes="ToolButton"
						Classes.active="{Binding CurrentTool, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static editor:EditorTool.Pencil}}"
						Command="{Binding SelectPencilToolCommand}"
						ToolTip.Tip="é“…ç¬”å·¥å…· - æ·»åŠ éŸ³ç¬¦">
					<TextBlock Text="âœ" HorizontalAlignment="Center" VerticalAlignment="Center"/>
				</Button>

				<!-- é€‰æ‹©å·¥å…· -->
				<Button Classes="ToolButton"
						Classes.active="{Binding CurrentTool, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static editor:EditorTool.Select}}"
						Command="{Binding SelectSelectionToolCommand}"
						ToolTip.Tip="é€‰æ‹©å·¥å…· - é€‰æ‹©å’Œç§»åŠ¨éŸ³ç¬¦">
					<TextBlock Text="âœ…" HorizontalAlignment="Center" VerticalAlignment="Center"/>
				</Button>

				<!-- æ©¡çš®å·¥å…· -->
				<Button Classes="ToolButton"
						Classes.active="{Binding CurrentTool, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static editor:EditorTool.Eraser}}"
						Command="{Binding SelectEraserToolCommand}"
						ToolTip.Tip="æ©¡çš®å·¥å…· - åˆ é™¤éŸ³ç¬¦">
					<TextBlock Text="ðŸ—‘" HorizontalAlignment="Center" VerticalAlignment="Center"/>
				</Button>

				<!-- åˆ‡å‰²å·¥å…· -->
				<Button Classes="ToolButton"
						Classes.active="{Binding CurrentTool, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static editor:EditorTool.Cut}}"
						Command="{Binding SelectCutToolCommand}"
						ToolTip.Tip="åˆ‡å‰²å·¥å…· - åˆ†å‰²éŸ³ç¬¦">
					<TextBlock Text="âœ‚" HorizontalAlignment="Center" VerticalAlignment="Center"/>
				</Button>

				<!-- åˆ†éš”çº¿ -->
				<Rectangle Width="1" Height="24" Fill="{DynamicResource ButtonBorderBrush}" Margin="8,0"/>

				<!-- ç½‘æ ¼é‡åŒ–é€‰æ‹©å™¨ -->
				<Grid>
					<Button Classes="NoteDurationButton"
							Command="{Binding ToggleNoteDurationDropDownCommand}"
							ToolTip.Tip="é€‰æ‹©ç½‘æ ¼é‡åŒ–">
						<StackPanel Orientation="Horizontal">
							<TextBlock Text="{Binding CurrentNoteDurationText}"
									   HorizontalAlignment="Center"
									   VerticalAlignment="Center"
									   FontWeight="Bold"/>
						</StackPanel>
					</Button>

					<!-- ç½‘æ ¼é‡åŒ–ä¸‹æ‹‰é€‰é¡¹ -->
					<Popup IsOpen="{Binding IsNoteDurationDropDownOpen, Mode=TwoWay}"
						   Placement="Bottom"
						   PlacementTarget="{Binding $parent[Button]}"
						   WindowManagerAddShadowHint="False">
						<Border Background="{DynamicResource PopupBackgroundBrush}"
								BorderBrush="{DynamicResource ButtonBorderBrush}"
								BorderThickness="1"
								CornerRadius="4"
								Padding="4"
								MaxHeight="300">
							<ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
								<StackPanel>
									<!-- é¢„å®šä¹‰é€‰é¡¹ -->
									<ItemsControl ItemsSource="{Binding NoteDurationOptions}">
										<ItemsControl.ItemTemplate>
											<DataTemplate DataType="models:NoteDurationOption">
												<Button Background="Transparent"
														BorderThickness="0"
														Padding="8,4"
														HorizontalAlignment="Stretch"
														HorizontalContentAlignment="Left"
														Command="{Binding $parent[UserControl].DataContext.SelectNoteDurationCommand}"
														CommandParameter="{Binding}">
													<StackPanel Orientation="Horizontal">
														<TextBlock Text="{Binding Icon}"
																   FontSize="14"
																   Margin="0,0,8,0"
																   VerticalAlignment="Center"/>
														<TextBlock Text="{Binding Name}"
																   VerticalAlignment="Center"/>
													</StackPanel>
												</Button>
											</DataTemplate>
										</ItemsControl.ItemTemplate>
									</ItemsControl>

									<!-- åˆ†éš”çº¿ -->
									<Rectangle Height="1" Fill="{DynamicResource SeparatorLineBrush}" Margin="4,8"/>

									<!-- è‡ªå®šä¹‰è¾“å…¥ -->
									<StackPanel Margin="8,4">
										<TextBlock Text="è‡ªå®šä¹‰ç½‘æ ¼:" FontWeight="Bold" Margin="0,0,0,4"/>
										<StackPanel Orientation="Horizontal">
											<TextBox Text="{Binding CustomFractionInput, Mode=TwoWay}"
													 Width="60"
													 Watermark="1/16"/>
											<Button Content="åº”ç”¨"
													Command="{Binding ApplyCustomFractionCommand}"
													Margin="4,0,0,0"
													Padding="8,2"/>
										</StackPanel>
									</StackPanel>
								</StackPanel>
							</ScrollViewer>
						</Border>
					</Popup>
				</Grid>

				<!-- åˆ†éš”çº¿ -->
				<Rectangle Width="1" Height="24" Fill="{DynamicResource ButtonBorderBrush}" Margin="8,0"/>

				<!-- è§†å›¾æŽ§åˆ¶æŒ‰é’® -->
				<Button Classes="ToolButton" 
				        Command="{Binding ToggleEventViewCommand}" 
				        ToolTip.Tip="åˆ‡æ¢äº‹ä»¶è§†å›¾"
				        Classes.active="{Binding IsEventViewVisible}">
					<TextBlock Text="ðŸ“Š" HorizontalAlignment="Center" VerticalAlignment="Center"/>
				</Button>

			<!-- I2M - ImageToMidi æŒ‰é’® -->
			<Button Classes="ToolButton"
			        ToolTip.Tip="ImageToMidi - å›¾ç‰‡è½¬MIDI"
			        Margin="2"
			        Command="{Binding LaunchImageToMidiCommand}"
			        IsEnabled="True">
				<TextBlock Text="ðŸ–¼" HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="14"/>
			</Button>

			<!-- åˆ†éš”çº¿ -->
			<Rectangle Width="1" Height="24" Fill="{DynamicResource ButtonBorderBrush}" Margin="8,0"/>

			<!-- æ’­æ”¾æŽ§åˆ¶æŒ‰é’® -->
			<!-- ä½¿ç”¨ ToolbarViewModel ä¸­çš„ PlaybackViewModel å±žæ€§ -->
			<!-- æ’­æ”¾æŒ‰é’® -->
			<Button Classes="ToolButton"
			        ToolTip.Tip="æ’­æ”¾ (Space)"
			        Margin="2"
			        Command="{Binding PlaybackViewModel.PlayCommand}"
			        IsEnabled="{Binding PlaybackViewModel, Converter={x:Static ObjectConverters.IsNotNull}}">
				<TextBlock Text="â–¶" HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="12"/>
			</Button>

			<!-- æš‚åœæŒ‰é’® -->
			<Button Classes="ToolButton"
			        ToolTip.Tip="æš‚åœ"
			        Margin="2"
			        Command="{Binding PlaybackViewModel.PauseCommand}"
			        IsEnabled="{Binding PlaybackViewModel, Converter={x:Static ObjectConverters.IsNotNull}}">
				<TextBlock Text="â¸" HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="12"/>
			</Button>

			<!-- åœæ­¢æŒ‰é’® -->
			<Button Classes="ToolButton"
			        ToolTip.Tip="åœæ­¢"
			        Margin="2"
			        Command="{Binding PlaybackViewModel.StopCommand}"
			        IsEnabled="{Binding PlaybackViewModel, Converter={x:Static ObjectConverters.IsNotNull}}">
				<TextBlock Text="â¹" HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="12"/>
			</Button>

			<!-- è‡ªåŠ¨è·Ÿéšæ’­æ”¾å¤´æŒ‰é’® -->
			<Button Classes="ToolButton"
			        ToolTip.Tip="è‡ªåŠ¨è·Ÿéšæ’­æ”¾å¤´ (æ’­æ”¾æ—¶è‡ªåŠ¨æ¨ªå‘æ»šåŠ¨)"
			        Margin="2"
			        Command="{Binding PlaybackViewModel.ToggleAutoScrollCommand}"
			        IsEnabled="{Binding PlaybackViewModel, Converter={x:Static ObjectConverters.IsNotNull}}"
			        Classes.active="{Binding PlaybackViewModel.IsAutoScrollEnabled}">
				<TextBlock Text="ðŸŽ¯" HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="12"/>
			</Button>

			<!-- æ»šåŠ¨åˆ°æ’­æ”¾å¤´æŒ‰é’® -->
			<Button Classes="ToolButton"
			        ToolTip.Tip="æ»šåŠ¨åˆ°æ’­æ”¾å¤´ä½ç½®"
			        Margin="2"
			        Command="{Binding PlaybackViewModel.ScrollToPlayheadCommand}"
			        IsEnabled="{Binding PlaybackViewModel, Converter={x:Static ObjectConverters.IsNotNull}}">
				<TextBlock Text="â‡¥" HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="14" FontWeight="Bold"/>
			</Button>

			<!-- åˆ†éš”çº¿ -->
			<Rectangle Width="1" Height="24" Fill="{DynamicResource ButtonBorderBrush}" Margin="8,0"/>

			<!-- å®žæ—¶Tempoæ˜¾ç¤º -->
			<StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="8,0">
				<TextBlock Text="BPM:"
						   FontSize="11"
						   Foreground="{DynamicResource StatusTextBrush}"
						   VerticalAlignment="Center"
						   Margin="0,0,4,0"/>
				<TextBlock Text="{Binding CurrentTempo}"
							   FontSize="12"
							   FontWeight="Bold"
							   Foreground="{DynamicResource StatusTextBrush}"
							   VerticalAlignment="Center"
							   MinWidth="30"
							   HorizontalAlignment="Center"/>
				</StackPanel>
			</StackPanel>

			<!-- çŠ¶æ€ä¿¡æ¯ -->
			<StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" Margin="8,0">
				<TextBlock Text="{Binding CurrentTool, StringFormat='å·¥å…·: {0}'}"
						   FontSize="11"
						   Foreground="{DynamicResource StatusTextBrush}"
						   VerticalAlignment="Center"
						   Margin="0,0,16,0"/>
				<TextBlock Text="{Binding CurrentNoteDurationText, StringFormat='ç½‘æ ¼: {0}'}"
						   FontSize="11"
						   Foreground="{DynamicResource StatusTextBrush}"
						   VerticalAlignment="Center"
						   Margin="0,0,8,0"/>
				<TextBlock Text="{Binding CurrentNoteTimeValueText, StringFormat='å½“å‰æ—¶å€¼: {0}'}"
						   FontSize="11"
						   Foreground="{DynamicResource StatusTextBrush}"
						   VerticalAlignment="Center"
						   Margin="0,0,8,0"/>
				<TextBlock Text="{Binding IsEventViewVisible, StringFormat='äº‹ä»¶è§†å›¾: {0}'}"
						   FontSize="11"
						   Foreground="{DynamicResource StatusTextBrush}"
						   VerticalAlignment="Center"/>
			</StackPanel>
		</Grid>
	</Border>
</UserControl>