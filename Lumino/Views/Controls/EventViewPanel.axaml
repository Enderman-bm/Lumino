<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:Lumino.ViewModels.Editor"
             xmlns:canvas="using:Lumino.Views.Controls.Canvas"
             xmlns:enums="using:Lumino.ViewModels.Editor.Enums"
             xmlns:editor="using:Lumino.ViewModels.Editor"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="150"
             x:Class="Lumino.Views.Controls.EventViewPanel"
             x:DataType="vm:PianoRollViewModel">

    <!-- äº‹ä»¶è§†å›¾åŒºåŸŸï¼ˆåŒ…å«è¾¹ç•Œçº¿ï¼‰ -->
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="1"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="1"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="1"/>
        </Grid.RowDefinitions>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="60"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="20"/>
        </Grid.ColumnDefinitions>

        <!-- é¡¶éƒ¨è¾¹ç•Œçº¿ -->
        <Border Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="3" 
                Background="{DynamicResource BorderLineBlackBrush}"/>

        <!-- CC å·¥å…·æ åˆ†åŒºï¼ˆä»…åœ¨äº‹ä»¶è§†å›¾å¯è§æ—¶æ˜¾ç¤ºï¼‰ -->
        <Border Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="3"
                Background="{DynamicResource ToolbarBackgroundBrush}"
                BorderBrush="{DynamicResource ToolbarBorderBrush}"
                BorderThickness="0,0,0,1"
                IsVisible="{Binding IsEventViewVisible}"
                Padding="8,4">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Spacing="4">
                <TextBlock Text="CCå·¥å…·:" FontSize="11" FontWeight="Bold" VerticalAlignment="Center" Foreground="{DynamicResource TextBrush}"/>
                
                <!-- CC ç‚¹å·¥å…· -->
                <Button Width="32" Height="32" Padding="0" Margin="0"
                        Background="Transparent" BorderThickness="1" BorderBrush="{DynamicResource ButtonBorderBrush}"
                        CornerRadius="4"
                        Classes.active="{Binding CurrentTool, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static editor:EditorTool.CCPoint}}"
                        Command="{Binding SelectCCPointToolCommand}"
                        ToolTip.Tip="CC ç‚¹å·¥å…· - å•å‡»æ·»åŠ /é€‰æ‹©æŽ§åˆ¶ç‚¹">
                    <TextBlock Text="â€¢" HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="16"/>
                </Button>

                <!-- CC ç›´çº¿å·¥å…· -->
                <Button Width="32" Height="32" Padding="0" Margin="0"
                        Background="Transparent" BorderThickness="1" BorderBrush="{DynamicResource ButtonBorderBrush}"
                        CornerRadius="4"
                        Classes.active="{Binding CurrentTool, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static editor:EditorTool.CCLine}}"
                        Command="{Binding SelectCCLineToolCommand}"
                        ToolTip.Tip="CC ç›´çº¿å·¥å…· - ä¸¤æ¬¡ç‚¹å‡»ç»˜åˆ¶ç›´çº¿æ®µ">
                    <TextBlock Text="ï¼" HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="16"/>
                </Button>

                <!-- CC æ›²çº¿å·¥å…· -->
                <Button Width="32" Height="32" Padding="0" Margin="0"
                        Background="Transparent" BorderThickness="1" BorderBrush="{DynamicResource ButtonBorderBrush}"
                        CornerRadius="4"
                        Classes.active="{Binding CurrentTool, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static editor:EditorTool.CCCurve}}"
                        Command="{Binding SelectCCCurveToolCommand}"
                        ToolTip.Tip="CC æ›²çº¿å·¥å…· - ç»˜åˆ¶å…‰æ»‘æ›²çº¿æ®µ">
                    <TextBlock Text="âˆ¿" HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="14"/>
                </Button>
            </StackPanel>
        </Border>

        <!-- åˆ†éš”çº¿ -->
        <Border Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="3"
                Background="{DynamicResource BorderLineBlackBrush}"/>

        <!-- å·¦ä¾§å›ºå®šåŒºåŸŸ - äº‹ä»¶ç±»åž‹é€‰æ‹©å™¨ -->
        <Border Grid.Row="3" Grid.Column="0" 
                Background="{DynamicResource MeasureHeaderBackgroundBrush}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- äº‹ä»¶ç±»åž‹é€‰æ‹©æŒ‰é’® -->
                <Button Grid.Row="0" 
                        Name="EventTypeSelectorButton"
                        Content="{Binding CurrentEventTypeText}"
                        ToolTip.Tip="{Binding CurrentEventDescription}"
                        Command="{Binding ToggleEventTypeSelectorCommand}"
                        Margin="4,4,4,2"
                        HorizontalAlignment="Stretch"
                        VerticalAlignment="Top"
                        FontSize="11"
                        FontWeight="Bold"/>

                <!-- äº‹ä»¶ç±»åž‹é€‰æ‹©å¼¹å‡ºèœå• -->
                <Popup Grid.Row="0"
                       IsOpen="{Binding IsEventTypeSelectorOpen}"
                       PlacementTarget="{Binding #EventTypeSelectorButton}"
                       PlacementMode="Bottom"
                       VerticalOffset="2">
                    <Border Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                            BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                            BorderThickness="1"
                            CornerRadius="3"
                            Padding="0">
                        <StackPanel>
                            <!-- Tempoé€‰é¡¹ - åªåœ¨Conductorè½¨é“æ˜¾ç¤º -->
                            <Button Content="ðŸŽµ é€Ÿåº¦ (BPM)"
                                    Command="{Binding SelectEventTypeCommand}"
                                    CommandParameter="{x:Static enums:EventType.Tempo}"
                                    HorizontalAlignment="Stretch"
                                    HorizontalContentAlignment="Left"
                                    Padding="8,6"
                                    FontSize="11"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    IsVisible="{Binding IsCurrentTrackConductor}"/>

                            <!-- åŠ›åº¦é€‰é¡¹ - åªåœ¨éžConductorè½¨é“æ˜¾ç¤º -->
                            <Button Content="ðŸ’ª åŠ›åº¦ (1-127)"
                                    Command="{Binding SelectEventTypeCommand}"
                                    CommandParameter="{x:Static enums:EventType.Velocity}"
                                    HorizontalAlignment="Stretch"
                                    HorizontalContentAlignment="Left"
                                    Padding="8,6"
                                    FontSize="11"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    IsVisible="{Binding IsCurrentTrackConductor, Converter={x:Static BoolConverters.Not}}"/>

                            <!-- å¼¯éŸ³é€‰é¡¹ - åªåœ¨éžConductorè½¨é“æ˜¾ç¤º -->
                            <Button Content="ðŸ“ˆ å¼¯éŸ³ (-8192~8191)"
                                    Command="{Binding SelectEventTypeCommand}"
                                    CommandParameter="{x:Static enums:EventType.PitchBend}"
                                    HorizontalAlignment="Stretch"
                                    HorizontalContentAlignment="Left"
                                    Padding="8,6"
                                    FontSize="11"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    IsVisible="{Binding IsCurrentTrackConductor, Converter={x:Static BoolConverters.Not}}"/>

                            <!-- CCé€‰é¡¹ - åªåœ¨éžConductorè½¨é“æ˜¾ç¤º -->
                            <Button Content="ðŸŽ›ï¸ CCæŽ§åˆ¶å™¨ (0-127)"
                                    Command="{Binding SelectEventTypeCommand}"
                                    CommandParameter="{x:Static enums:EventType.ControlChange}"
                                    HorizontalAlignment="Stretch"
                                    HorizontalContentAlignment="Left"
                                    Padding="8,6"
                                    FontSize="11"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    IsVisible="{Binding IsCurrentTrackConductor, Converter={x:Static BoolConverters.Not}}"/>
                        </StackPanel>
                    </Border>
                </Popup>

                <!-- CCå·ç è¾“å…¥æ¡†ï¼ˆä»…åœ¨é€‰æ‹©CCç±»åž‹æ—¶æ˜¾ç¤ºä¸”éžConductorè½¨é“ï¼‰ -->
                <StackPanel Grid.Row="1"
                           Orientation="Vertical"
                           IsVisible="{Binding CurrentEventType, Converter={StaticResource ObjectEqualsConverter}, ConverterParameter={x:Static enums:EventType.ControlChange}}"
                           Margin="4,2,4,4">
                    <TextBlock Text="CCå·:" 
                               FontSize="10" 
                               Margin="0,0,0,2"
                               HorizontalAlignment="Center"
                               FontWeight="Bold"/>
                    <TextBox x:Name="CCNumberTextBox"
                             Text="{Binding CurrentCCNumber}" 
                             FontSize="11"
                             Height="28"
                             HorizontalAlignment="Stretch"
                             HorizontalContentAlignment="Center"
                             MaxLength="3"
                             VerticalContentAlignment="Center"
                             Padding="2,3"
                             Foreground="{DynamicResource SystemControlForegroundBaseMediumHighBrush}"/>
                    <TextBlock Text="èŒƒå›´: 0-127"
                               FontSize="9"
                               Opacity="0.6"
                               Margin="0,2,0,0"
                               HorizontalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- ä¸­é—´äº‹ä»¶è§†å›¾åŒºåŸŸ - ä½¿ç”¨å›ºå®šCanvasï¼Œæ”¯æŒåŠ¨æ€æ»šåŠ¨ -->
        <Border Grid.Row="3" Grid.Column="1"
                Background="{DynamicResource MainCanvasBackgroundBrush}"
                ClipToBounds="True">
            
            <!-- ä½¿ç”¨ Grid æ¥å åŠ äº‹ä»¶è§†å›¾å’ŒåŠ›åº¦è§†å›¾ -->
            <Grid>
                <!-- èƒŒæ™¯å±‚ï¼šäº‹ä»¶è§†å›¾ç½‘æ ¼å’Œæ—¶é—´çº¿ -->
                <canvas:EventViewCanvas ViewModel="{Binding}"
                                        IsHitTestVisible="False"
                                        x:Name="EventViewCanvas"/>

                <!-- åŠ›åº¦è§†å›¾å±‚ï¼šå¯äº¤äº’çš„åŠ›åº¦æ¡æ˜¾ç¤º -->
                <canvas:VelocityViewCanvas ViewModel="{Binding}"
                                           IsHitTestVisible="True"
                                           x:Name="VelocityViewCanvas"/>
            </Grid>
        </Border>

        <!-- å³ä¾§å›ºå®šåŒºåŸŸ -->
        <Border Grid.Row="3" Grid.Column="2" 
                Background="{DynamicResource MeasureHeaderBackgroundBrush}"/>

        <!-- åº•éƒ¨è¾¹ç•Œçº¿ -->
        <Border Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="3" 
                Background="{DynamicResource BorderLineBlackBrush}"/>
    </Grid>
</UserControl>