<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:Lumino.ViewModels"
             mc:Ignorable="d" d:DesignWidth="200" d:DesignHeight="60"
             x:Class="Lumino.Views.Controls.TrackPanel"
             x:DataType="vm:TrackViewModel">

    <UserControl.Styles>
        <!-- 音轨按钮样式 -->
        <Style Selector="Button.TrackButton">
            <Setter Property="Width" Value="24"/>
            <Setter Property="Height" Value="20"/>
            <Setter Property="Margin" Value="1"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="3"/>
            <Setter Property="FontSize" Value="10"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
        </Style>

        <!-- 静音按钮样式 -->
        <Style Selector="Button.TrackButton.Mute">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="{DynamicResource ButtonBorderBrush}"/>
            <Setter Property="Foreground" Value="{DynamicResource StatusTextBrush}"/>
        </Style>

        <Style Selector="Button.TrackButton.Mute:pointerover">
            <Setter Property="Background" Value="{DynamicResource ButtonHoverBrush}"/>
        </Style>

        <Style Selector="Button.TrackButton.Mute.active">
            <Setter Property="Background" Value="#FFD700"/>
            <Setter Property="BorderBrush" Value="#FFB000"/>
            <Setter Property="Foreground" Value="Black"/>
        </Style>

        <!-- 静音按钮激活状态下的鼠标悬停效果 -->
        <Style Selector="Button.TrackButton.Mute.active:pointerover">
            <Setter Property="Background" Value="#E6C200"/>
            <Setter Property="BorderBrush" Value="#CC9900"/>
            <Setter Property="Foreground" Value="Black"/>
        </Style>

        <!-- 独奏按钮样式 -->
        <Style Selector="Button.TrackButton.Solo">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="{DynamicResource ButtonBorderBrush}"/>
            <Setter Property="Foreground" Value="{DynamicResource StatusTextBrush}"/>
        </Style>

        <Style Selector="Button.TrackButton.Solo:pointerover">
            <Setter Property="Background" Value="{DynamicResource ButtonHoverBrush}"/>
        </Style>

        <Style Selector="Button.TrackButton.Solo.active">
            <Setter Property="Background" Value="#FF4444"/>
            <Setter Property="BorderBrush" Value="#CC0000"/>
            <Setter Property="Foreground" Value="White"/>
        </Style>

        <!-- 独奏按钮激活状态下的鼠标悬停效果 -->
        <Style Selector="Button.TrackButton.Solo.active:pointerover">
            <Setter Property="Background" Value="#E63333"/>
            <Setter Property="BorderBrush" Value="#AA0000"/>
            <Setter Property="Foreground" Value="White"/>
        </Style>

        <!-- 音轨面板样式 -->
        <Style Selector="Border.TrackPanel">
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="BorderBrush" Value="{DynamicResource ToolbarBorderBrush}"/>
            <Setter Property="Background" Value="Transparent"/>
        </Style>

        <Style Selector="Border.TrackPanel.selected">
            <Setter Property="Background" Value="{DynamicResource ButtonActiveBrush}"/>
        </Style>

        <Style Selector="Border.TrackPanel:pointerover">
            <Setter Property="Background" Value="{DynamicResource ButtonHoverBrush}"/>
        </Style>

        <Style Selector="Border.TrackPanel.selected:pointerover">
            <Setter Property="Background" Value="{DynamicResource ButtonActiveBrush}"/>
        </Style>

        <!-- Conductor轨特殊样式 -->
        <Style Selector="Border.TrackPanel.conductor">
            <Setter Property="Background" Value="#FFF8DC"/>
            <Setter Property="BorderBrush" Value="#DDD"/>
        </Style>

        <Style Selector="Border.TrackPanel.conductor.selected">
            <Setter Property="Background" Value="#F0E68C"/>
        </Style>

        <Style Selector="Border.TrackPanel.conductor:pointerover">
            <Setter Property="Background" Value="#F5F5DC"/>
        </Style>

        <Style Selector="Border.TrackPanel.conductor.selected:pointerover">
            <Setter Property="Background" Value="#F0E68C"/>
        </Style>

        <!-- 可编辑文本框样式 -->
        <Style Selector="TextBox.TrackName">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="4,2"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style Selector="TextBox.TrackName:focus">
            <Setter Property="Background" Value="{DynamicResource TextControlBackground}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="{DynamicResource TextControlBorderBrush}"/>
        </Style>

        <!-- Conductor轨名称样式（只读） -->
        <Style Selector="TextBlock.ConductorTrackName">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Padding" Value="4,2"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Foreground" Value="#8B4513"/>
        </Style>
    </UserControl.Styles>

    <Border Classes="TrackPanel" 
            Classes.selected="{Binding IsSelected}"
            Classes.conductor="{Binding IsConductorTrack}"
            Height="60"
            x:Name="TrackBorder">
        
        <Grid Margin="6,4">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="40"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- 音轨号 -->
            <TextBlock Grid.Column="0" Grid.Row="0" 
                       Text="{Binding TrackNumber, StringFormat='{}{0:D2}'}"
                       FontSize="12" FontWeight="Bold"
                       HorizontalAlignment="Center"
                       Foreground="{DynamicResource StatusTextBrush}"/>

            <!-- 通道名 -->
            <TextBlock Grid.Column="0" Grid.Row="1"
                       Text="{Binding ChannelName}"
                       FontSize="10"
                       HorizontalAlignment="Center"
                       Foreground="{DynamicResource StatusTextBrush}"
                       Opacity="0.8"/>

            <!-- 音轨名称 - 根据是否为Conductor轨选择不同的控件 -->
            <!-- 普通音轨使用可编辑TextBox -->
            <TextBox Grid.Column="1" Grid.Row="0" Grid.RowSpan="2"
                     Classes="TrackName"
                     Text="{Binding TrackName}"
                     Margin="8,0,4,0"
                     IsVisible="{Binding !IsConductorTrack}"/>

            <!-- Conductor轨使用只读TextBlock -->
            <TextBlock Grid.Column="1" Grid.Row="0" Grid.RowSpan="2"
                       Classes="ConductorTrackName"
                       Text="{Binding TrackName}"
                       Margin="8,0,4,0"
                       IsVisible="{Binding IsConductorTrack}"/>

            <!-- 控制按钮 - 只在非Conductor轨显示 -->
            <StackPanel Grid.Column="2" Grid.Row="0" Grid.RowSpan="2"
                        Orientation="Horizontal"
                        VerticalAlignment="Center"
                        IsVisible="{Binding !IsConductorTrack}">
                
                <!-- 静音按钮 -->
                <Button Classes="TrackButton Mute"
                        Classes.active="{Binding IsMuted}"
                        Command="{Binding ToggleMuteCommand}"
                        ToolTip.Tip="静音 (Mute)">
                    <TextBlock Text="M"/>
                </Button>

                <!-- 独奏按钮 -->
                <Button Classes="TrackButton Solo"
                        Classes.active="{Binding IsSolo}"
                        Command="{Binding ToggleSoloCommand}"
                        ToolTip.Tip="独奏 (Solo)">
                    <TextBlock Text="S"/>
                </Button>
            </StackPanel>

            <!-- Conductor轨的特殊标识 -->
            <TextBlock Grid.Column="2" Grid.Row="0" Grid.RowSpan="2"
                       Text="♪"
                       FontSize="16"
                       VerticalAlignment="Center"
                       HorizontalAlignment="Center"
                       Foreground="#8B4513"
                       ToolTip.Tip="Conductor轨（速度轨）"
                       IsVisible="{Binding IsConductorTrack}"/>
        </Grid>
    </Border>
</UserControl>