<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:i="https://github.com/avaloniaui/avalonia.xaml.behaviors"
             xmlns:vm="using:Lumino.ViewModels.Editor"
             xmlns:models="using:Lumino.Models.Music"
             xmlns:controls="using:Lumino.Views.Controls"
             xmlns:editing="using:Lumino.Views.Controls.Editing"
             xmlns:canvas="using:Lumino.Views.Controls.Canvas"
             xmlns:converters="using:Lumino.Views.Converters"
             
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="Lumino.Views.PianoRollView"
             x:DataType="vm:PianoRollViewModel">

	<Design.DataContext>
		<vm:PianoRollViewModel/>
	</Design.DataContext>

	<UserControl.Styles>
		<!-- è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ -->
		<Style Selector="canvas|HorizontalScrollBarCanvas">
			<Setter Property="TrackBrush" Value="{DynamicResource SliderTrackBrush}"/>
			<Setter Property="ThumbBrush" Value="{DynamicResource SliderThumbBrush}"/>
			<Setter Property="ThumbHoverBrush" Value="{DynamicResource SliderThumbHoverBrush}"/>
			<Setter Property="ThumbPressedBrush" Value="{DynamicResource SliderThumbPressedBrush}"/>
			<Setter Property="CornerRadius" Value="3"/>
		</Style>

		<Style Selector="canvas|VerticalScrollBarCanvas">
			<Setter Property="TrackBrush" Value="{DynamicResource SliderTrackBrush}"/>
			<Setter Property="ThumbBrush" Value="{DynamicResource SliderThumbBrush}"/>
			<Setter Property="ThumbHoverBrush" Value="{DynamicResource SliderThumbHoverBrush}"/>
			<Setter Property="ThumbPressedBrush" Value="{DynamicResource SliderThumbPressedBrush}"/>
			<Setter Property="CornerRadius" Value="3"/>
		</Style>

		<Style Selector="GridSplitter">
			<Setter Property="Background" Value="{DynamicResource SeparatorLineBrush}"/>
		</Style>

		<Style Selector="GridSplitter:pointerover">
			<Setter Property="Background" Value="{DynamicResource ButtonBorderBrush}"/>
		</Style>
	</UserControl.Styles>

	<UserControl.Resources>

	</UserControl.Resources>

	<Grid>
		<Grid.RowDefinitions>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="3*" MinHeight="150"/>
			<!-- åˆ†éš”æ¡è¡Œï¼šæ ¹æ®äº‹ä»¶è§†å›¾å¯è§æ€§åŠ¨æ€è°ƒæ•´é«˜åº¦ -->
			<RowDefinition Height="{Binding IsEventViewVisible, Converter={x:Static converters:BooleanToGridLengthConverter.Instance}, ConverterParameter='Auto,0'}"/>
			<!-- äº‹ä»¶è§†å›¾è¡Œï¼šæ ¹æ®å¯è§æ€§åŠ¨æ€è°ƒæ•´é«˜åº¦ -->
			<RowDefinition Height="{Binding IsEventViewVisible, Converter={x:Static converters:BooleanToGridLengthConverter.Instance}, ConverterParameter='1*,0'}"/>
			<RowDefinition Height="Auto"/>
		</Grid.RowDefinitions>

		<!-- å·¥å…·æ  - ä½¿ç”¨æ–°çš„ç‹¬ç«‹å·¥å…·æ æŽ§ä»¶ -->
		<controls:Toolbar Grid.Row="0" 
		                  x:Name="ToolbarControl"/>

		<!-- å›ºå®šçš„å°èŠ‚æ ‡é¢˜åŒºåŸŸ -->
		<Grid Grid.Row="1" Height="30">
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="60"/>
				<ColumnDefinition Width="*"/>
				<ColumnDefinition Width="20"/>
			</Grid.ColumnDefinitions>

			<Border Grid.Column="0" Background="{DynamicResource MeasureHeaderBackgroundBrush}"/>

			<Border Grid.Column="1"
			        Background="{DynamicResource MeasureHeaderBackgroundBrush}"
			        ClipToBounds="True">
				<canvas:MeasureHeaderCanvas ViewModel="{Binding}"
											  Height="30"
											  x:Name="MeasureHeaderCanvas"/>
			</Border>

			<Border Grid.Column="2" Background="{DynamicResource MeasureHeaderBackgroundBrush}"/>
		</Grid>

		<!-- ä¸»å†…å®¹åŒºåŸŸï¼šé’¢ç´é”® + éŸ³ç¬¦åŒºåŸŸ + åž‚ç›´æŽ§åˆ¶æ¡ -->
		<Grid Grid.Row="2">
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="60"/>
				<ColumnDefinition Width="*"/>
				<ColumnDefinition Width="20"/>
			</Grid.ColumnDefinitions>

			<!-- å›ºå®šçš„é’¢ç´é”®åŒºåŸŸ -->
			<ScrollViewer Grid.Column="0"
						  x:Name="PianoKeysScrollViewer"
						  HorizontalScrollBarVisibility="Disabled"
						  VerticalScrollBarVisibility="Hidden"
						  Background="{DynamicResource PianoKeysBackgroundBrush}"
						  VerticalAlignment="Top"
						  VerticalContentAlignment="Top"
						  HorizontalAlignment="Stretch"
						  HorizontalContentAlignment="Stretch">
				<canvas:PianoKeysCanvas ViewModel="{Binding}"
										   Width="60"
										   Height="{Binding TotalHeight}"
										   VerticalAlignment="Top"
										   HorizontalAlignment="Left"/>
			</ScrollViewer>

			<!-- éŸ³ç¬¦åŒºåŸŸ - ä½¿ç”¨å›ºå®šå¤§å°çš„Canvasï¼Œä¸ä½¿ç”¨ScrollViewerçš„å†…å®¹æ»šåŠ¨ -->
			<Border Grid.Column="1" 
			        Background="{DynamicResource MainCanvasBackgroundBrush}"
			        ClipToBounds="True"
			        x:Name="PianoRenderArea"
			        VerticalAlignment="Top"
			        HorizontalAlignment="Stretch">
				
				<!-- ä½¿ç”¨ Grid æ¥å åŠ å¤šä¸ªå±‚ -->
				<Grid VerticalAlignment="Top"
				      HorizontalAlignment="Stretch"
				      Height="{Binding TotalHeight}">
					<!-- èƒŒæ™¯å±‚ï¼šç½‘æ ¼å’Œæ—¶é—´çº¿ -->
					<canvas:PianoRollCanvas ViewModel="{Binding}"
				                                        IsHitTestVisible="False"
				                                        x:Name="PianoRollCanvas"
				                                        VerticalAlignment="Top"
				                                        HorizontalAlignment="Stretch"
				                                        Height="{Binding TotalHeight}"/>

					<!-- é¢‘è°±å›¾å±‚ï¼šç‹¬ç«‹æ˜¾ç¤ºåœ¨è§¦æŽ§å±‚ä¸‹æ–¹ï¼Œä¸Žé’¢ç´é”®å¯¹é½ï¼Œç¦ç”¨æŠ—é”¯é½¿ -->
            <Border Background="Transparent"
                     IsHitTestVisible="False"
                     VerticalAlignment="Bottom"
                     HorizontalAlignment="Stretch"
                     Height="{Binding TotalHeight}"
                     ZIndex="10">
                 <Image x:Name="SpectrogramLayer"
                        Stretch="None"
                        IsHitTestVisible="False"
                        VerticalAlignment="Bottom"
                        HorizontalAlignment="Left"
                        Width="{Binding SpectrogramWidth, FallbackValue=0}"
                        Height="{Binding SpectrogramHeight, FallbackValue=0}"
                        Opacity="{Binding SpectrogramOpacity}"
                        Source="{Binding SpectrogramImage}"
                        IsVisible="{Binding IsSpectrogramVisible}"
                        Margin="{Binding ScrollBarManager.HorizontalScrollBar.Value, Converter={x:Static converters:NegativeMarginConverter.Instance}, Mode=OneWay}"
                        RenderTransformOrigin="0,0">
                     <Image.RenderTransform>
                         <TransformGroup>
                             <ScaleTransform ScaleX="{Binding Zoom, Mode=OneWay}"/>
                             <ScaleTransform ScaleY="{Binding VerticalZoom, Mode=OneWay}"/>
                         </TransformGroup>
                     </Image.RenderTransform>
                 </Image>
             </Border>

					<!-- éŸ³ç¬¦ç¼–è¾‘å±‚ï¼šç”¨ Border åŒ…è£¹ï¼Œæä¾›é€æ˜ŽèƒŒæ™¯å‚ä¸Žå‘½ä¸­æµ‹è¯• -->
					<Border Background="Transparent"
				                        ZIndex="999"
				                        VerticalAlignment="Top"
				                        HorizontalAlignment="Stretch"
				                        Height="{Binding TotalHeight}">
						<editing:NoteEditingLayer ViewModel="{Binding}"
				                                              Focusable="True"
				                                              IsHitTestVisible="True"
				                                              x:Name="NoteEditingLayer"
				                                              VerticalAlignment="Top"
				                                              HorizontalAlignment="Stretch"
				                                              Height="{Binding TotalHeight}"/>
					</Border>
				</Grid>
			</Border>

			<!-- åž‚ç›´æŽ§åˆ¶æ¡ï¼šåž‚ç›´æ»šåŠ¨æ¡ -->
			<Grid Grid.Column="2">
				<Grid.RowDefinitions>
					<RowDefinition Height="*"/>
					<RowDefinition Height="Auto"/>
				</Grid.RowDefinitions>

				<!-- åž‚ç›´æ»šåŠ¨æ¡ -->
				<Border Grid.Row="0" Background="{DynamicResource MainCanvasBackgroundBrush}">
					<canvas:VerticalScrollBarCanvas ViewModel="{Binding ScrollBarManager.VerticalScrollBar}"
					                               x:Name="VerticalScrollBarCanvas"
					                               HorizontalAlignment="Stretch"
					                               VerticalAlignment="Stretch"/>
				</Border>

				<Border Grid.Row="1" Height="1" Background="{DynamicResource ButtonBorderBrush}" Margin="2,2"/>
			</Grid>
		</Grid>

	<!-- å¯æ‹–æ‹½çš„åˆ†éš”æ¡ - åªæœ‰åœ¨äº‹ä»¶è§†å›¾å¯è§æ—¶æ‰æ˜¾ç¤º -->
	<GridSplitter Grid.Row="3"
				  Height="4"
				  HorizontalAlignment="Stretch"
				  Background="{DynamicResource SeparatorLineBrush}"
				  Cursor="SizeNorthSouth"
				  IsVisible="{Binding IsEventViewVisible}"/>

	<!-- ä½¿ç”¨æ–°çš„äº‹ä»¶è§†å›¾é¢æ¿ç»„ä»¶ -->
	<controls:EventViewPanel Grid.Row="4"
	                        x:Name="EventViewPanel"
	                        ViewModel="{Binding}"
	                        IsEventViewVisible="{Binding IsEventViewVisible}"/>

	<!-- å¼€å‘ä¸­æç¤ºåŒºåŸŸï¼ˆä»…åœ¨éžDebugæ¨¡å¼æ˜¾ç¤ºï¼‰ -->
	<Border Grid.Row="4"
	        x:Name="DevelopmentNoticeBorder"
	        Background="#1E1E1E"
	        BorderBrush="#404040"
	        BorderThickness="0,1,0,1">
		<Grid>
			<StackPanel VerticalAlignment="Center" 
			           HorizontalAlignment="Center"
			           Orientation="Vertical"
			           Spacing="12">
				<TextBlock Text="ðŸ”§ CCç»˜åˆ¶é¢æ¿" 
				          FontSize="16"
				          FontWeight="Bold"
				          Foreground="#FFD700"
				          HorizontalAlignment="Center"/>
				<TextBlock Text="æ­¤åŠŸèƒ½ä»…åœ¨Debugæ¨¡å¼ä¸‹å¯ç”¨" 
				          FontSize="13"
				          Foreground="#A0A0A0"
				          HorizontalAlignment="Center"/>
				<TextBlock Text="ä½¿ç”¨ --debug å‚æ•°å¯åŠ¨åº”ç”¨ä»¥å¯ç”¨æ­¤åŠŸèƒ½" 
				          FontSize="11"
				          Foreground="#707070"
				          HorizontalAlignment="Center"
				          FontStyle="Italic"/>
			</StackPanel>
		</Grid>
	</Border>		<!-- åº•éƒ¨æŽ§åˆ¶æ ï¼šæ°´å¹³æ»šåŠ¨æ¡ -->
		<Grid Grid.Row="5" Height="20">
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="60"/>
				<ColumnDefinition Width="*"/>
				<ColumnDefinition Width="20"/>
			</Grid.ColumnDefinitions>

			<Border Grid.Column="0" Background="{DynamicResource MainCanvasBackgroundBrush}"/>

			<!-- æ¨ªå‘æ»šåŠ¨æ¡ -->
			<Border Grid.Column="1" Background="{DynamicResource MainCanvasBackgroundBrush}">
				<canvas:HorizontalScrollBarCanvas ViewModel="{Binding ScrollBarManager.HorizontalScrollBar}"
				                                 x:Name="HorizontalScrollBarCanvas"
				                                 HorizontalAlignment="Stretch"
				                                 VerticalAlignment="Stretch"/>
			</Border>

			<Border Grid.Column="2" Background="{DynamicResource MainCanvasBackgroundBrush}"/>
		</Grid>
	</Grid>
</UserControl>