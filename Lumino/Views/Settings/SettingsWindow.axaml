<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Lumino.ViewModels.Settings"
        xmlns:models="using:Lumino.Models.Settings"
        xmlns:converters="using:Lumino.Views.Converters"
        xmlns:controls="using:Avalonia.Controls"
        xmlns:localControls="using:Lumino.Views.Controls"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="900" d:DesignHeight="700"
        x:Class="Lumino.Views.Settings.SettingsWindow"
        x:DataType="vm:SettingsWindowViewModel"
        Title="设置 - Lumino"
        Width="900" Height="700"
        MinWidth="800" MinHeight="600"
        WindowStartupLocation="CenterOwner"
        ShowInTaskbar="False"
        Icon="/Assets/avalonia-logo.ico"
        FontFamily="Microsoft YaHei">

	<Window.Resources>
		<converters:ObjectEqualsConverter x:Key="ObjectEqualsConverter"/>
	</Window.Resources>

	<Design.DataContext>
		<vm:SettingsWindowViewModel/>
	</Design.DataContext>

	<Grid>
		<Grid.RowDefinitions>
			<RowDefinition Height="*"/>
		</Grid.RowDefinitions>

		<!-- 主内容区域 -->
		<Grid Grid.Row="0">
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="250"/>
				<ColumnDefinition Width="*"/>
			</Grid.ColumnDefinitions>

			<!-- 左侧导航 -->
			<Border Grid.Column="0"
                    Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                    BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
                    BorderThickness="0,0,1,0">
				<ScrollViewer>
					<StackPanel Margin="10">
						<TextBlock Text="设置类别"
                                   FontWeight="Bold"
                                   FontSize="16"
                                   Margin="0,0,0,15"/>

						<ItemsControl ItemsSource="{Binding Pages}">
							<ItemsControl.ItemTemplate>
								<DataTemplate DataType="models:SettingsPageInfo">
									<Button Classes="SettingsNavButton"
                                            Command="{Binding $parent[ItemsControl].DataContext.SelectPageCommand}"
                                            CommandParameter="{Binding Type}"
                                            HorizontalAlignment="Stretch"
                                            HorizontalContentAlignment="Left"
                                            Margin="0,2">
										<Button.Styles>
											<Style Selector="Button.SettingsNavButton">
												<Setter Property="Background" Value="Transparent"/>
												<Setter Property="BorderThickness" Value="0"/>
												<Setter Property="Padding" Value="12,8"/>
												<Setter Property="CornerRadius" Value="4"/>
											</Style>
											<Style Selector="Button.SettingsNavButton:pointerover">
												<Setter Property="Background" Value="{DynamicResource SystemControlHighlightListLowBrush}"/>
											</Style>
										</Button.Styles>

										<StackPanel Orientation="Horizontal">
											<TextBlock Text="{Binding Icon}"
                                                       FontSize="16"
                                                       VerticalAlignment="Center"
                                                       Margin="0,0,8,0"/>
											<StackPanel>
												<TextBlock Text="{Binding Title}"
                                                           FontWeight="Medium"/>
												<TextBlock Text="{Binding Description}"
                                                           FontSize="12"
                                                           Opacity="0.7"/>
											</StackPanel>
										</StackPanel>
									</Button>
								</DataTemplate>
							</ItemsControl.ItemTemplate>
						</ItemsControl>
					</StackPanel>
				</ScrollViewer>
			</Border>

			<!-- 右侧内容区域 -->
			<ScrollViewer Grid.Column="1" Padding="30,20">
				<StackPanel>
					<!-- 常规设置 -->
					<StackPanel IsVisible="{Binding SelectedPageType, Converter={StaticResource ObjectEqualsConverter}, ConverterParameter={x:Static models:SettingsPageType.General}}">
						<TextBlock Text="常规设置" FontSize="24" FontWeight="Bold" Margin="0,0,0,20"/>

						<StackPanel Spacing="20">
							<!-- 自动保存 -->
							<StackPanel>
								<TextBlock Text="自动保存" FontWeight="Medium" Margin="0,0,0,8"/>
								<CheckBox Content="启用自动保存" IsChecked="{Binding Settings.AutoSave}"/>

								<StackPanel Orientation="Horizontal"
                                            Margin="0,8,0,0"
                                            IsVisible="{Binding Settings.AutoSave}">
									<TextBlock Text="保存间隔:" VerticalAlignment="Center" Margin="0,0,8,0"/>
									<NumericUpDown Value="{Binding Settings.AutoSaveInterval}"
                                                   Minimum="1" Maximum="60"
                                                   Width="80"
                                                   VerticalAlignment="Center"/>
									<TextBlock Text="分钟" VerticalAlignment="Center" Margin="8,0,0,0"/>
								</StackPanel>
							</StackPanel>

							<CheckBox Content="使用原生菜单栏" IsChecked="{Binding Settings.UseNativeMenuBar}"/>

							<StackPanel>
								<TextBlock Text="最大撤销步数" FontWeight="Medium" Margin="0,0,0,8"/>
								<NumericUpDown Value="{Binding Settings.MaxUndoSteps}"
                                               Minimum="10" Maximum="1000"
                                               Width="100"/>
							</StackPanel>

							<CheckBox Content="删除前确认" IsChecked="{Binding Settings.ConfirmBeforeDelete}"/>
						</StackPanel>
					</StackPanel>

					<!-- 语言设置 -->
					<StackPanel IsVisible="{Binding SelectedPageType, Converter={StaticResource ObjectEqualsConverter}, ConverterParameter={x:Static models:SettingsPageType.Language}}">
						<TextBlock Text="语言设置" FontSize="24" FontWeight="Bold" Margin="0,0,0,20"/>

						<StackPanel Spacing="15">
							<TextBlock Text="选择界面语言:" FontWeight="Medium"/>

							<ItemsControl ItemsSource="{Binding LanguageOptions}">
								<ItemsControl.ItemTemplate>
									<DataTemplate DataType="models:LanguageOption">
										<RadioButton GroupName="Language"
                                                     Content="{Binding NativeName}"
                                                     IsChecked="{Binding Code, Converter={StaticResource ObjectEqualsConverter}, ConverterParameter={Binding $parent[Window].DataContext.SelectedLanguageCode}}"
                                                     Command="{Binding $parent[Window].DataContext.ApplyLanguageCommand}"
                                                     CommandParameter="{Binding Code}"
                                                     Margin="0,4"/>
									</DataTemplate>
								</ItemsControl.ItemTemplate>
							</ItemsControl>

							<TextBlock Text="注意：更改语言后需要重启应用程序才能完全生效。"
                                       FontStyle="Italic"
                                       Opacity="0.7"
                                       Margin="0,10,0,0"/>
						</StackPanel>
					</StackPanel>

					<!-- 主题设置 -->
					<StackPanel IsVisible="{Binding SelectedPageType, Converter={StaticResource ObjectEqualsConverter}, ConverterParameter={x:Static models:SettingsPageType.Theme}}">
						<TextBlock Text="主题设置" FontSize="24" FontWeight="Bold" Margin="0,0,0,20"/>

						<StackPanel Spacing="15">
							<TextBlock Text="选择应用主题:" FontWeight="Medium"/>

							<ItemsControl ItemsSource="{Binding ThemeOptions}">
								<ItemsControl.ItemTemplate>
									<DataTemplate DataType="models:ThemeOption">
										<RadioButton GroupName="Theme"
                                                     IsChecked="{Binding Key, Converter={StaticResource ObjectEqualsConverter}, ConverterParameter={Binding $parent[Window].DataContext.SelectedThemeKey}}"
                                                     Command="{Binding $parent[Window].DataContext.ApplyThemeCommand}"
                                                     CommandParameter="{Binding Key}"
                                                     Margin="0,8" VerticalAlignment="Center">
											<StackPanel>
												<TextBlock Text="{Binding Name}" FontWeight="Medium" VerticalAlignment="Center"/>
												<TextBlock Text="{Binding Description}"
                                                           FontSize="12"
                                                           Opacity="0.7"
                                                           VerticalAlignment="Center"/>
											</StackPanel>
										</RadioButton>
									</DataTemplate>
								</ItemsControl.ItemTemplate>
							</ItemsControl>

							<!-- 已移除自定义颜色设置面板（包括分组、预览、输入框、重置按钮等），如需恢复请参考历史版本。-->
						</StackPanel>
					</StackPanel>

					<!-- 编辑器设置 -->
					<StackPanel IsVisible="{Binding SelectedPageType, Converter={StaticResource ObjectEqualsConverter}, ConverterParameter={x:Static models:SettingsPageType.Editor}}">
						<TextBlock Text="编辑器设置" FontSize="24" FontWeight="Bold" Margin="0,0,0,20"/>

						<StackPanel Spacing="20">
							<StackPanel>
								<TextBlock Text="网格和对齐" FontWeight="Medium" Margin="0,0,0,8"/>
								<CheckBox Content="显示网格线" IsChecked="{Binding Settings.ShowGridLines}"/>
								<CheckBox Content="启用网格对齐" IsChecked="{Binding Settings.SnapToGrid}" Margin="0,8,0,0"/>
							</StackPanel>

							<StackPanel>
								<TextBlock Text="显示选项" FontWeight="Medium" Margin="0,0,0,8"/>
								<CheckBox Content="显示力度条" IsChecked="{Binding Settings.ShowVelocityBars}"/>
							</StackPanel>

							<StackPanel>
								<TextBlock Text="默认缩放" FontWeight="Medium" Margin="0,0,0,8"/>
								<Slider Value="{Binding Settings.DefaultZoom}"
                                        Minimum="0.1" Maximum="5.0"
                                        TickFrequency="0.1"
                                        Width="200"
                                        HorizontalAlignment="Left"/>
								<TextBlock Text="{Binding Settings.DefaultZoom, StringFormat='{}{0:F1}x'}"
                                           Margin="0,4,0,0"/>
							</StackPanel>

							<StackPanel>
								<TextBlock Text="钢琴键宽度" FontWeight="Medium" Margin="0,0,0,8"/>
								<NumericUpDown Value="{Binding Settings.PianoKeyWidth}"
                                               Minimum="40" Maximum="120"
                                               Width="100"/>
							</StackPanel>
						</StackPanel>
					</StackPanel>

					<!-- 快捷键设置 -->
					<StackPanel IsVisible="{Binding SelectedPageType, Converter={StaticResource ObjectEqualsConverter}, ConverterParameter={x:Static models:SettingsPageType.Shortcuts}}">
						<TextBlock Text="快捷键设置" FontSize="24" FontWeight="Bold" Margin="0,0,0,20"/>

						<StackPanel Spacing="15">
							<CheckBox Content="启用键盘快捷键" IsChecked="{Binding Settings.EnableKeyboardShortcuts}"/>

							<StackPanel Orientation="Horizontal" Spacing="10" Margin="0,10,0,0">
								<Button Content="重置所有快捷键" Command="{Binding ResetAllShortcutsCommand}"/>
							</StackPanel>

							<controls:DataGrid ItemsSource="{Binding ShortcutSettings}"
                                      AutoGenerateColumns="False"
                                      CanUserReorderColumns="False"
                                      CanUserResizeColumns="True"
                                      CanUserSortColumns="True"
                                      GridLinesVisibility="Horizontal"
                                      HeadersVisibility="Column"
                                      MinHeight="300"
                                      VerticalAlignment="Stretch">
								<controls:DataGrid.Columns>
									<controls:DataGridTextColumn Header="类别" Binding="{Binding Category}" Width="80" IsReadOnly="True"/>
									<controls:DataGridTextColumn Header="命令" Binding="{Binding Description}" Width="150" IsReadOnly="True"/>
									<controls:DataGridTextColumn Header="快捷键" Binding="{Binding CurrentShortcut}" Width="120"/>
									<controls:DataGridTextColumn Header="默认" Binding="{Binding DefaultShortcut}" Width="120" IsReadOnly="True"/>
									<controls:DataGridTemplateColumn Header="操作" Width="80">
										<controls:DataGridTemplateColumn.CellTemplate>
											<DataTemplate>
												<Button Content="重置"
                                                        Command="{Binding $parent[controls:DataGrid].DataContext.ResetShortcutCommand}"
                                                        CommandParameter="{Binding}"
                                                        HorizontalAlignment="Center"
                                                        VerticalAlignment="Center"/>
											</DataTemplate>
										</controls:DataGridTemplateColumn.CellTemplate>
									</controls:DataGridTemplateColumn>
								</controls:DataGrid.Columns>
							</controls:DataGrid>
						</StackPanel>
					</StackPanel>

					<!-- 高级设置 -->
					<StackPanel IsVisible="{Binding SelectedPageType, Converter={StaticResource ObjectEqualsConverter}, ConverterParameter={x:Static models:SettingsPageType.Advanced}}">
						<TextBlock Text="高级设置" FontSize="24" FontWeight="Bold" Margin="0,0,0,20"/>

						<StackPanel Spacing="20">
							<TextBlock Text="调试和性能选项" FontWeight="Medium"/>

							<Button Content="重置所有设置"
                                    Command="{Binding ResetToDefaultsCommand}"
                                    HorizontalAlignment="Left"
                                    Background="Orange"
                                    Foreground="White"/>

							<TextBlock Text="警告：重置所有设置将恢复为默认值，此操作不可撤销。"
                                       FontStyle="Italic"
                                       Opacity="0.7"/>

							<StackPanel Orientation="Horizontal" Spacing="10" Margin="0,20,0,0">
								<Button Content="从文件加载设置"
                                        Click="LoadSettingsFromFile_Click"
                                        ToolTip.Tip="从配置文件重新加载设置"/>
								<Button Content="保存设置到文件"
                                        Click="SaveSettingsToFile_Click"
                                        ToolTip.Tip="将当前设置保存到配置文件"/>
							</StackPanel>
						</StackPanel>
					</StackPanel>

					<!-- 关于页面 -->
					<StackPanel IsVisible="{Binding SelectedPageType, Converter={StaticResource ObjectEqualsConverter}, ConverterParameter={x:Static models:SettingsPageType.About}}">
						<TextBlock Text="关于 Lumino" FontSize="24" FontWeight="Bold" Margin="0,0,0,20"/>

						<StackPanel Spacing="30">
							<!-- 项目信息 -->
							<Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
									BorderThickness="1"
									CornerRadius="12"
									Padding="30">
								<StackPanel HorizontalAlignment="Center" Spacing="20">
									<!-- Logo -->
									<Image Source="/Assets/avalonia-logo.ico"
										   Width="80" Height="80"
										   HorizontalAlignment="Center"/>

									<!-- 项目名称和版本 -->
									<StackPanel HorizontalAlignment="Center" Spacing="5">
										<TextBlock Text="Lumino"
												   FontSize="28"
												   FontWeight="Bold"
												   HorizontalAlignment="Center"/>
										<TextBlock Text="{Binding AboutViewModel.Version}"
												   FontSize="16"
												   Opacity="0.7"
												   HorizontalAlignment="Center"/>
									</StackPanel>

									<!-- 项目描述 -->
									<TextBlock Text="专业的MIDI编辑器，为音乐创作提供强大的钢琴卷帘功能"
											   TextWrapping="Wrap"
											   TextAlignment="Center"
											   FontSize="14"
											   Opacity="0.8"
											   MaxWidth="400"/>
								</StackPanel>
							</Border>

							<!-- 贡献者列表 -->
							<StackPanel Spacing="15">
								<StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch">
									<TextBlock Text="贡献者" FontSize="18" FontWeight="Medium"/>
									<Button Content="刷新"
											Command="{Binding AboutViewModel.RefreshContributorsCommand}"
											IsEnabled="{Binding !AboutViewModel.IsLoadingContributors}"
											Padding="12,6"
											HorizontalAlignment="Right"/>
								</StackPanel>

								<!-- 加载状态 -->
								<StackPanel IsVisible="{Binding AboutViewModel.IsLoadingContributors}"
											HorizontalAlignment="Center"
											Margin="0,20">
									<ProgressBar IsIndeterminate="True" Width="200"/>
									<TextBlock Text="正在加载贡献者信息..."
											   HorizontalAlignment="Center"
											   Margin="0,10,0,0"
											   Opacity="0.7"/>
								</StackPanel>

								<!-- 错误信息 -->
								<Border IsVisible="{Binding AboutViewModel.ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
										Background="{DynamicResource SystemControlErrorTextForegroundBrush}"
										BorderThickness="1"
										CornerRadius="4"
										Padding="15"
										Margin="0,10">
									<TextBlock Text="{Binding AboutViewModel.ErrorMessage}"
											   Foreground="White"
											   TextWrapping="Wrap"/>
								</Border>

								<!-- 贡献者网格 -->
								<ItemsControl ItemsSource="{Binding AboutViewModel.Contributors}"
											  IsVisible="{Binding !AboutViewModel.IsLoadingContributors}">
									<ItemsControl.ItemsPanel>
										<ItemsPanelTemplate>
											<WrapPanel Orientation="Horizontal" HorizontalAlignment="Center"/>
										</ItemsPanelTemplate>
									</ItemsControl.ItemsPanel>
									<ItemsControl.ItemTemplate>
										<DataTemplate DataType="vm:Contributor">
											<Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
													BorderThickness="1"
													CornerRadius="8"
													Padding="12"
													Margin="4"
													Width="120">
												<StackPanel HorizontalAlignment="Center" Spacing="8">
													<!-- 头像 -->
													<Image Source="{Binding AvatarUrl}"
														   Width="48" Height="48"
														   HorizontalAlignment="Center">
														<Image.Styles>
															<Style Selector="Image">
																<Setter Property="Clip">
																	<EllipseGeometry Rect="0,0,48,48"/>
																</Setter>
															</Style>
														</Image.Styles>
													</Image>

													<!-- 姓名 -->
													<TextBlock Text="{Binding Name}"
															   FontWeight="Medium"
															   FontSize="12"
															   TextAlignment="Center"
															   TextWrapping="Wrap"
															   MaxWidth="100"/>

													<!-- 贡献次数 -->
													<TextBlock Text="{Binding Contributions, StringFormat='{}{0} 次贡献'}"
															   FontSize="10"
															   Opacity="0.6"
															   TextAlignment="Center"/>
												</StackPanel>
											</Border>
										</DataTemplate>
									</ItemsControl.ItemTemplate>
								</ItemsControl>
							</StackPanel>
						</StackPanel>
					</StackPanel>
				</StackPanel>
			</ScrollViewer>
		</Grid>
	</Grid>
</Window>