<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:i="https://github.com/avaloniaui/avalonia.xaml.behaviors"
             xmlns:vm="using:DominoNext.ViewModels.Editor"
             xmlns:models="using:DominoNext.Models.Music"
             xmlns:controls="using:DominoNext.Views.Controls"
             xmlns:editing="using:DominoNext.Views.Controls.Editing"
             xmlns:canvas="using:DominoNext.Views.Controls.Canvas"
             xmlns:converters="using:DominoNext.Views.Converters"
             
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="DominoNext.Views.PianoRollView"
             x:DataType="vm:PianoRollViewModel">

	<Design.DataContext>
		<vm:PianoRollViewModel/>
	</Design.DataContext>

	<UserControl.Styles>
		<!-- å·¥å…·æ æŒ‰é’®æ ·å¼ -->
		<Style Selector="Button.ToolButton">
			<Setter Property="Width" Value="32"/>
			<Setter Property="Height" Value="32"/>
			<Setter Property="Margin" Value="2"/>
			<Setter Property="Padding" Value="0"/>
			<Setter Property="Background" Value="Transparent"/>
			<Setter Property="BorderThickness" Value="1"/>
			<Setter Property="BorderBrush" Value="{DynamicResource ButtonBorderBrush}"/>
			<Setter Property="CornerRadius" Value="4"/>
		</Style>

		<Style Selector="Button.ToolButton:pointerover">
			<Setter Property="Background" Value="{DynamicResource ButtonHoverBrush}"/>
			<Setter Property="BorderBrush" Value="{DynamicResource ButtonActiveBrush}"/>
		</Style>

		<Style Selector="Button.ToolButton:pressed">
			<Setter Property="Background" Value="{DynamicResource ButtonPressedBrush}"/>
		</Style>

		<Style Selector="Button.ToolButton.active">
			<Setter Property="Background" Value="{DynamicResource ButtonActiveBrush}"/>
			<Setter Property="BorderBrush" Value="{DynamicResource SliderThumbPressedBrush}"/>
		</Style>

		<!-- éŸ³ç¬¦æ—¶å€¼æŒ‰é’®æ ·å¼ -->
		<Style Selector="Button.NoteDurationButton">
			<Setter Property="MinWidth" Value="50"/>
			<Setter Property="Height" Value="32"/>
			<Setter Property="Margin" Value="2"/>
			<Setter Property="Padding" Value="4,0"/>
			<Setter Property="Background" Value="Transparent"/>
			<Setter Property="BorderThickness" Value="1"/>
			<Setter Property="BorderBrush" Value="{DynamicResource ButtonBorderBrush}"/>
			<Setter Property="CornerRadius" Value="4"/>
			<Setter Property="HorizontalContentAlignment" Value="Center"/>
			<Setter Property="VerticalContentAlignment" Value="Center"/>
		</Style>

		<Style Selector="Button.NoteDurationButton:pointerover">
			<Setter Property="Background" Value="{DynamicResource ButtonHoverBrush}"/>
			<Setter Property="BorderBrush" Value="{DynamicResource ButtonActiveBrush}"/>
		</Style>

		<Style Selector="Button.NoteDurationButton:pressed">
			<Setter Property="Background" Value="{DynamicResource ButtonPressedBrush}"/>
		</Style>

		<!-- ç¡®ä¿ TextBlock åœ¨æŒ‰é’®ä¸­å±…ä¸­ -->
		<Style Selector="Button TextBlock">
			<Setter Property="HorizontalAlignment" Value="Center"/>
			<Setter Property="VerticalAlignment" Value="Center"/>
			<Setter Property="TextAlignment" Value="Center"/>
		</Style>

		<!-- è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ -->
		<Style Selector="canvas|HorizontalScrollBarCanvas">
			<Setter Property="TrackBrush" Value="{DynamicResource SliderTrackBrush}"/>
			<Setter Property="ThumbBrush" Value="{DynamicResource SliderThumbBrush}"/>
			<Setter Property="ThumbHoverBrush" Value="{DynamicResource SliderThumbHoverBrush}"/>
			<Setter Property="ThumbPressedBrush" Value="{DynamicResource SliderThumbPressedBrush}"/>
			<Setter Property="CornerRadius" Value="3"/>
		</Style>

		<Style Selector="canvas|VerticalScrollBarCanvas">
			<Setter Property="TrackBrush" Value="{DynamicResource SliderTrackBrush}"/>
			<Setter Property="ThumbBrush" Value="{DynamicResource SliderThumbBrush}"/>
			<Setter Property="ThumbHoverBrush" Value="{DynamicResource SliderThumbHoverBrush}"/>
			<Setter Property="ThumbPressedBrush" Value="{DynamicResource SliderThumbPressedBrush}"/>
			<Setter Property="CornerRadius" Value="3"/>
		</Style>

		<Style Selector="GridSplitter">
			<Setter Property="Background" Value="{DynamicResource SeparatorLineBrush}"/>
		</Style>

		<Style Selector="GridSplitter:pointerover">
			<Setter Property="Background" Value="{DynamicResource ButtonBorderBrush}"/>
		</Style>
	</UserControl.Styles>

	<UserControl.Resources>

	</UserControl.Resources>

	<Grid>
		<Grid.RowDefinitions>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="3*" MinHeight="150"/>
			<!-- åˆ†éš”æ¡è¡Œï¼šæ ¹æ®äº‹ä»¶è§†å›¾å¯è§æ€§åŠ¨æ€è°ƒæ•´é«˜åº¦ -->
			<RowDefinition Height="{Binding IsEventViewVisible, Converter={x:Static converters:BooleanToGridLengthConverter.Instance}, ConverterParameter='Auto,0'}"/>
			<!-- äº‹ä»¶è§†å›¾è¡Œï¼šæ ¹æ®å¯è§æ€§åŠ¨æ€è°ƒæ•´é«˜åº¦ -->
			<RowDefinition Height="{Binding IsEventViewVisible, Converter={x:Static converters:BooleanToGridLengthConverter.Instance}, ConverterParameter='1*,0'}"/>
			<RowDefinition Height="Auto"/>
		</Grid.RowDefinitions>

		<!-- å·¥å…·æ  -->
		<Border Grid.Row="0" Background="{DynamicResource ToolbarBackgroundBrush}" Height="44" BorderBrush="{DynamicResource ToolbarBorderBrush}" BorderThickness="0,0,0,1">
			<Grid>
				<Grid.ColumnDefinitions>
					<ColumnDefinition Width="Auto"/>
					<ColumnDefinition Width="*"/>
					<ColumnDefinition Width="Auto"/>
				</Grid.ColumnDefinitions>

				<!-- å·¥å…·æŒ‰é’®ç»„ -->
				<StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center" Margin="8,0">
					<!-- é“…ç¬”å·¥å…· -->
					<Button Classes="ToolButton"
							Classes.active="{Binding CurrentTool, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static vm:EditorTool.Pencil}}"
							Command="{Binding SelectPencilToolCommand}"
							ToolTip.Tip="é“…ç¬”å·¥å…· - æ·»åŠ éŸ³ç¬¦">
						<TextBlock Text="âœï¸" HorizontalAlignment="Center" VerticalAlignment="Center"/>
					</Button>

					<!-- é€‰æ‹©å·¥å…· -->
					<Button Classes="ToolButton"
							Classes.active="{Binding CurrentTool, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static vm:EditorTool.Select}}"
							Command="{Binding SelectSelectionToolCommand}"
							ToolTip.Tip="é€‰æ‹©å·¥å…· - é€‰æ‹©å’Œç§»åŠ¨éŸ³ç¬¦">
						<TextBlock Text="â¬†ï¸" HorizontalAlignment="Center" VerticalAlignment="Center"/>
					</Button>

					<!-- æ©¡çš®å·¥å…· -->
					<Button Classes="ToolButton"
							Classes.active="{Binding CurrentTool, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static vm:EditorTool.Eraser}}"
							Command="{Binding SelectEraserToolCommand}"
							ToolTip.Tip="æ©¡çš®å·¥å…· - åˆ é™¤éŸ³ç¬¦">
						<TextBlock Text="ðŸ§½" HorizontalAlignment="Center" VerticalAlignment="Center"/>
					</Button>

					<!-- åˆ‡å‰²å·¥å…· -->
					<Button Classes="ToolButton"
							Classes.active="{Binding CurrentTool, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static vm:EditorTool.Cut}}"
							Command="{Binding SelectCutToolCommand}"
							ToolTip.Tip="åˆ‡å‰²å·¥å…· - åˆ†å‰²éŸ³ç¬¦">
						<TextBlock Text="âœ‚ï¸" HorizontalAlignment="Center" VerticalAlignment="Center"/>
					</Button>

					<!-- åˆ†éš”çº¿ -->
					<Rectangle Width="1" Height="24" Fill="{DynamicResource ButtonBorderBrush}" Margin="8,0"/>

					<!-- ç½‘æ ¼é‡åŒ–é€‰æ‹©å™¨ -->
					<Grid>
						<Button Classes="NoteDurationButton"
								Command="{Binding ToggleNoteDurationDropDownCommand}"
								ToolTip.Tip="é€‰æ‹©ç½‘æ ¼é‡åŒ–">
							<StackPanel Orientation="Horizontal">
								<!--TextBlock Text="ç½‘æ ¼:"
										   FontSize="10"
										   VerticalAlignment="Center"
										   Margin="0,0,4,0"/-->
								<TextBlock Text="{Binding CurrentNoteDurationText}"
										   HorizontalAlignment="Center"
										   VerticalAlignment="Center"
										   FontWeight="Bold"/>
							</StackPanel>
						</Button>

						<!-- ç½‘æ ¼é‡åŒ–ä¸‹æ‹‰é€‰é¡¹ -->
						<Popup IsOpen="{Binding IsNoteDurationDropDownOpen, Mode=TwoWay}"
							   Placement="Bottom"
							   PlacementTarget="{Binding $parent[Button]}"
							   WindowManagerAddShadowHint="False">
							<Border Background="{DynamicResource PopupBackgroundBrush}"
									BorderBrush="{DynamicResource ButtonBorderBrush}"
									BorderThickness="1"
									CornerRadius="4"
									Padding="4"
									MaxHeight="300">
								<ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
									<StackPanel>
										<!-- é¢„å®šä¹‰é€‰é¡¹ -->
										<ItemsControl ItemsSource="{Binding NoteDurationOptions}">
											<ItemsControl.ItemTemplate>
												<DataTemplate DataType="models:NoteDurationOption">
													<Button Background="Transparent"
															BorderThickness="0"
															Padding="8,4"
															HorizontalAlignment="Stretch"
															HorizontalContentAlignment="Left"
															Command="{Binding $parent[UserControl].DataContext.SelectNoteDurationCommand}"
															CommandParameter="{Binding}">
														<StackPanel Orientation="Horizontal">
															<TextBlock Text="{Binding Icon}"
																	   FontSize="14"
																	   Margin="0,0,8,0"
																	   VerticalAlignment="Center"/>
															<TextBlock Text="{Binding Name}"
																	   VerticalAlignment="Center"/>
														</StackPanel>
													</Button>
												</DataTemplate>
											</ItemsControl.ItemTemplate>
										</ItemsControl>

										<!-- åˆ†éš”çº¿ -->
										<Rectangle Height="1" Fill="{DynamicResource SeparatorLineBrush}" Margin="4,8"/>

										<!-- è‡ªå®šä¹‰è¾“å…¥ -->
										<StackPanel Margin="8,4">
											<TextBlock Text="è‡ªå®šä¹‰ç½‘æ ¼:" FontWeight="Bold" Margin="0,0,0,4"/>
											<StackPanel Orientation="Horizontal">
												<TextBox Text="{Binding $parent[UserControl].DataContext.CustomFractionInput, Mode=TwoWay}"
														 Width="60"
														 Watermark="1/16"/>
												<Button Content="åº”ç”¨"
														Command="{Binding $parent[UserControl].DataContext.ApplyCustomFractionCommand}"
														Margin="4,0,0,0"
														Padding="8,2"/>
											</StackPanel>
										</StackPanel>
									</StackPanel>
								</ScrollViewer>
							</Border>
						</Popup>
					</Grid>

					<!-- åˆ†éš”çº¿ -->
					<Rectangle Width="1" Height="24" Fill="{DynamicResource ButtonBorderBrush}" Margin="8,0"/>

					<!-- è§†å›¾æŽ§åˆ¶æŒ‰é’® -->
					<Button Classes="ToolButton" 
					        Command="{Binding ToggleEventViewCommand}" 
					        ToolTip.Tip="åˆ‡æ¢äº‹ä»¶è§†å›¾"
					        Classes.active="{Binding IsEventViewVisible}">
						<TextBlock Text="ðŸ“Š" HorizontalAlignment="Center" VerticalAlignment="Center"/>
					</Button>

					<!-- åˆ†éš”çº¿ -->
					<Rectangle Width="1" Height="24" Fill="{DynamicResource ButtonBorderBrush}" Margin="8,0"/>

					<!-- å®žæ—¶Tempoæ˜¾ç¤º -->
					<StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="8,0">
						<TextBlock Text="BPM:"
								   FontSize="11"
								   Foreground="{DynamicResource StatusTextBrush}"
								   VerticalAlignment="Center"
								   Margin="0,0,4,0"/>
						<TextBlock Text="{Binding CurrentTempo}"
								   FontSize="12"
								   FontWeight="Bold"
								   Foreground="{DynamicResource StatusTextBrush}"
								   VerticalAlignment="Center"
								   MinWidth="30"
								   HorizontalAlignment="Center"/>
					</StackPanel>
				</StackPanel>

				<!-- çŠ¶æ€ä¿¡æ¯ -->
				<StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" Margin="8,0">
					<TextBlock Text="{Binding CurrentTool, StringFormat='å·¥å…·: {0}'}"
							   FontSize="11"
							   Foreground="{DynamicResource StatusTextBrush}"
							   VerticalAlignment="Center"
							   Margin="0,0,16,0"/>
					<TextBlock Text="{Binding CurrentNoteDurationText, StringFormat='ç½‘æ ¼: {0}'}"
							   FontSize="11"
							   Foreground="{DynamicResource StatusTextBrush}"
							   VerticalAlignment="Center"
							   Margin="0,0,8,0"/>
					<TextBlock Text="{Binding CurrentNoteTimeValueText, StringFormat='å½“å‰æ—¶å€¼: {0}'}"
							   FontSize="11"
							   Foreground="{DynamicResource StatusTextBrush}"
							   VerticalAlignment="Center"
							   Margin="0,0,8,0"/>
					<TextBlock Text="{Binding IsEventViewVisible, StringFormat='äº‹ä»¶è§†å›¾: {0}'}"
							   FontSize="11"
							   Foreground="{DynamicResource StatusTextBrush}"
							   VerticalAlignment="Center"/>
				</StackPanel>
			</Grid>
		</Border>

		<!-- å›ºå®šçš„å°èŠ‚æ ‡é¢˜åŒºåŸŸ -->
		<Grid Grid.Row="1" Height="30">
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="60"/>
				<ColumnDefinition Width="*"/>
				<ColumnDefinition Width="20"/>
			</Grid.ColumnDefinitions>

			<Border Grid.Column="0" Background="{DynamicResource MeasureHeaderBackgroundBrush}"/>

			<Border Grid.Column="1"
			        Background="{DynamicResource MeasureHeaderBackgroundBrush}"
			        ClipToBounds="True">
				<canvas:MeasureHeaderCanvas ViewModel="{Binding}"
											  Height="30"
											  x:Name="MeasureHeaderCanvas"/>
			</Border>

			<Border Grid.Column="2" Background="{DynamicResource MeasureHeaderBackgroundBrush}"/>
		</Grid>

		<!-- ä¸»å†…å®¹åŒºåŸŸï¼šé’¢ç´é”® + éŸ³ç¬¦åŒºåŸŸ + åž‚ç›´æŽ§åˆ¶æ¡ -->
		<Grid Grid.Row="2">
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="60"/>
				<ColumnDefinition Width="*"/>
				<ColumnDefinition Width="20"/>
			</Grid.ColumnDefinitions>

			<!-- å›ºå®šçš„é’¢ç´é”®åŒºåŸŸ -->
			<ScrollViewer Grid.Column="0"
						  x:Name="PianoKeysScrollViewer"
						  HorizontalScrollBarVisibility="Disabled"
						  VerticalScrollBarVisibility="Hidden"
						  Background="{DynamicResource PianoKeysBackgroundBrush}"
						  VerticalAlignment="Top"
						  VerticalContentAlignment="Top"
						  HorizontalAlignment="Stretch"
						  HorizontalContentAlignment="Stretch">
				<canvas:PianoKeysCanvas ViewModel="{Binding}"
										   Width="60"
										   Height="{Binding TotalHeight}"
										   VerticalAlignment="Top"
										   HorizontalAlignment="Left"/>
			</ScrollViewer>

			<!-- éŸ³ç¬¦åŒºåŸŸ - ä½¿ç”¨å›ºå®šå¤§å°çš„Canvasï¼Œä¸ä½¿ç”¨ScrollViewerçš„å†…å®¹æ»šåŠ¨ -->
			<Border Grid.Column="1" 
			        Background="{DynamicResource MainCanvasBackgroundBrush}"
			        ClipToBounds="True"
			        x:Name="PianoRenderArea"
			        VerticalAlignment="Top"
			        HorizontalAlignment="Stretch">
				
				<!-- ä½¿ç”¨ Grid æ¥å åŠ å¤šä¸ªå±‚ -->
				<Grid VerticalAlignment="Top" 
				      HorizontalAlignment="Stretch"
				      Height="{Binding TotalHeight}">
					<!-- èƒŒæ™¯å±‚ï¼šç½‘æ ¼å’Œæ—¶é—´çº¿ -->
					<canvas:PianoRollCanvas ViewModel="{Binding}"
                                            IsHitTestVisible="False"
                                            x:Name="PianoRollCanvas"
                                            VerticalAlignment="Top"
                                            HorizontalAlignment="Stretch"
                                            Height="{Binding TotalHeight}"/>

					<!-- éŸ³ç¬¦ç¼–è¾‘å±‚ï¼šç”¨ Border åŒ…è£¹ï¼Œæä¾›é€æ˜ŽèƒŒæ™¯å‚ä¸Žå‘½ä¸­æµ‹è¯• -->
					<Border Background="Transparent"
                            ZIndex="999"
                            VerticalAlignment="Top"
                            HorizontalAlignment="Stretch"
                            Height="{Binding TotalHeight}">
						<editing:NoteEditingLayer ViewModel="{Binding}"
                                                  Focusable="True"
                                                  IsHitTestVisible="True"
                                                  x:Name="NoteEditingLayer"
                                                  VerticalAlignment="Top"
                                                  HorizontalAlignment="Stretch"
                                                  Height="{Binding TotalHeight}"/>
					</Border>
				</Grid>
			</Border>

			<!-- åž‚ç›´æŽ§åˆ¶æ¡ï¼šåž‚ç›´æ»šåŠ¨æ¡ + åž‚ç›´æ»‘å— -->
			<Grid Grid.Column="2">
				<Grid.RowDefinitions>
					<RowDefinition Height="*"/>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="80"/>
				</Grid.RowDefinitions>

				<!-- åž‚ç›´æ»šåŠ¨æ¡ -->
				<Border Grid.Row="0" Background="{DynamicResource MainCanvasBackgroundBrush}">
					<canvas:VerticalScrollBarCanvas ViewModel="{Binding ScrollBarManager.VerticalScrollBar}"
					                               x:Name="VerticalScrollBarCanvas"
					                               HorizontalAlignment="Stretch"
					                               VerticalAlignment="Stretch"/>
				</Border>

				<Border Grid.Row="1" Height="1" Background="{DynamicResource ButtonBorderBrush}" Margin="2,2"/>

				<Border Grid.Row="2" Background="{DynamicResource MainCanvasBackgroundBrush}">
					<Slider Classes="CustomVerticalZoomSlider"
							Minimum="0"
							Maximum="100"
							Value="{Binding VerticalZoomSliderValue, Mode=TwoWay}"
							TickFrequency="1"
							IsSnapToTickEnabled="False"
							HorizontalAlignment="Center"
							Margin="0,5"/>
				</Border>
			</Grid>
		</Grid>

		<!-- å¯æ‹–æ‹½çš„åˆ†éš”æ¡ - åªæœ‰åœ¨äº‹ä»¶è§†å›¾å¯è§æ—¶æ‰æ˜¾ç¤º -->
		<GridSplitter Grid.Row="3"
					  Height="4"
					  HorizontalAlignment="Stretch"
					  Background="{DynamicResource SeparatorLineBrush}"
					  Cursor="SizeNorthSouth"
					  IsVisible="{Binding IsEventViewVisible}"/>

		<!-- ä½¿ç”¨æ–°çš„äº‹ä»¶è§†å›¾é¢æ¿ç»„ä»¶ -->
		<controls:EventViewPanel Grid.Row="4"
		                        x:Name="EventViewPanel"
		                        ViewModel="{Binding}"
		                        IsEventViewVisible="{Binding IsEventViewVisible}"/>

		<!-- åº•éƒ¨æŽ§åˆ¶æ ï¼šæ°´å¹³æ»šåŠ¨æ¡ -->
		<Grid Grid.Row="5" Height="20">
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="60"/>
				<ColumnDefinition Width="*"/>
				<ColumnDefinition Width="20"/>
			</Grid.ColumnDefinitions>

			<Border Grid.Column="0" Background="{DynamicResource MainCanvasBackgroundBrush}"/>

			<!-- æ¨ªå‘æ»šåŠ¨æ¡ -->
			<Border Grid.Column="1" Background="{DynamicResource MainCanvasBackgroundBrush}">
				<canvas:HorizontalScrollBarCanvas ViewModel="{Binding ScrollBarManager.HorizontalScrollBar}"
				                                 x:Name="HorizontalScrollBarCanvas"
				                                 HorizontalAlignment="Stretch"
				                                 VerticalAlignment="Stretch"/>
			</Border>

			<Border Grid.Column="2" Background="{DynamicResource MainCanvasBackgroundBrush}"/>
		</Grid>
	</Grid>
</UserControl>